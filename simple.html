<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æƒ…æ„Ÿæ’ç”»ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        @keyframes slideInFromLeft {
            0% { transform: translateX(-30px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInFromRight {
            0% { transform: translateX(30px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInFromBottom {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.3); }
        }

        @keyframes musicNote {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-3px) rotate(10deg); opacity: 0.6; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes slideInFromTop {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInScale {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes typewriter {
            0% { width: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { width: 100%; opacity: 1; }
        }

        @keyframes fadeInUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes coverGlow {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(0,0,0,0.2),
                           0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 12px 35px rgba(0,0,0,0.3),
                           0 0 0 4px rgba(102, 126, 234, 0.6);
            }
        }

        @keyframes vinylSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç‰¹æ®Šæ•ˆæœ */
        .comment-card:hover .shine-effect {
            left: 100% !important;
        }

        /* å°é¢æ‚¬åœæ•ˆæœ */
        .song-cover:hover {
            animation: coverGlow 1.5s ease-in-out infinite;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
            color: #495057;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #495057;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 400;
        }

        .header p {
            color: #6c757d;
            font-size: 16px;
            font-weight: 300;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }

        .form-section, .preview-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .form-section h3, .preview-section h3 {
            color: #495057;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: #495057;
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #adb5bd;
            box-shadow: 0 0 0 3px rgba(173, 181, 189, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        .btn {
            background: linear-gradient(135deg, #868e96, #6c757d);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-weight: 300;
        }

        .btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        /* è¯„è®ºå¡ç‰‡æ ·å¼ */
        .comment-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            max-width: 400px;
            margin: 0 auto;
        }

        .comment-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .avatar-container {
            flex-shrink: 0;
        }

        .avatar-ring {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e9ecef, #ced4da);
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 18px;
            font-weight: 300;
            color: #6c757d;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .username-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .username {
            font-size: 16px;
            font-weight: 400;
            color: #495057;
        }

        .vip-badge {
            background: linear-gradient(135deg, #adb5bd, #868e96);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 300;
        }

        .date-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date {
            font-size: 13px;
            color: #adb5bd;
            font-weight: 300;
        }

        .hot-tag {
            background: #6c757d;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 300;
        }

        .likes-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .likes-count {
            font-size: 14px;
            color: #868e96;
            font-weight: 400;
        }

        .like-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .comment-content {
            font-size: 16px;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 16px;
            word-wrap: break-word;
            font-weight: 300;
        }

        .comment-footer {
            border-top: 1px solid #e9ecef;
            padding-top: 12px;
        }

        .reply-count {
            font-size: 14px;
            color: #868e96;
            font-weight: 300;
        }

        .export-btn {
            background: linear-gradient(135deg, #868e96, #6c757d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 300;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 8px 24px rgba(108, 117, 125, 0.2);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .comment-card {
            transition: all 0.3s ease;
        }

        .comment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .form-section, .preview-section {
            transition: all 0.3s ease;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fadeIn 0.6s ease-out;
        }

        /* æ­Œæ›²æœç´¢ç»“æœæ ·å¼ */
        .song-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            display: none;
        }

        .song-item {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .song-item:hover {
            background-color: #f8f9fa;
            transform: translateX(4px);
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: #e9ecef;
        }

        .song-info {
            flex: 1;
        }

        .song-name {
            font-size: 14px;
            font-weight: 400;
            color: #495057;
            margin-bottom: 2px;
        }

        .song-artist {
            font-size: 12px;
            color: #6c757d;
        }

        /* é€‰ä¸­çš„æ­Œæ›²æ˜¾ç¤º */
        .selected-song {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: none;
        }

        .selected-song-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selected-song-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .selected-song-details h4 {
            font-size: 14px;
            color: #495057;
            margin-bottom: 4px;
            font-weight: 400;
        }

        .selected-song-details p {
            font-size: 12px;
            color: #6c757d;
            margin: 0;
        }

        /* è¯„è®ºå¡ç‰‡ä¸­çš„æ­Œæ›²åŒºåŸŸæ ·å¼ */
        .song-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(233, 236, 239, 0.5);
        }

        .song-cover-container {
            flex-shrink: 0;
        }

        .card-song-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .card-song-cover:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .card-song-cover::after {
            content: 'â–¶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .card-song-cover:hover::after {
            opacity: 1;
        }

        .song-details {
            flex: 1;
            min-width: 0;
        }

        .song-title {
            font-size: 15px;
            font-weight: 400;
            color: #495057;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-details .song-artist {
            font-size: 13px;
            color: #6c757d;
            font-weight: 300;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 14px;
            }

            .content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .form-section, .preview-section {
                padding: 16px;
            }

            .form-section h3, .preview-section h3 {
                font-size: 18px;
                margin-bottom: 16px;
            }

            .form-group input, .form-group textarea, .form-group select {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 10px;
            }

            .comment-card {
                max-width: 100%;
                padding: 16px;
            }

            .avatar-ring {
                width: 45px;
                height: 45px;
            }

            .avatar {
                width: 41px;
                height: 41px;
                font-size: 16px;
            }

            .username {
                font-size: 15px;
            }

            .comment-content {
                font-size: 15px;
            }

            /* ç§»åŠ¨ç«¯æ­Œæ›²åŒºåŸŸä¼˜åŒ– */
            .song-section {
                flex-direction: column;
                text-align: center;
                gap: 8px;
                padding: 10px;
            }

            .card-song-cover {
                width: 50px;
                height: 50px;
            }

            .song-title {
                font-size: 14px;
            }

            .song-details .song-artist {
                font-size: 12px;
            }

            .song-results {
                max-height: 150px;
            }

            .song-item {
                padding: 10px;
            }

            .song-cover {
                width: 35px;
                height: 35px;
            }

            .selected-song-cover {
                width: 45px;
                height: 45px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .header {
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .content {
                gap: 15px;
            }

            .form-section, .preview-section {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>éŸ³ä¹æƒ…æ„Ÿæ’ç”»ç”Ÿæˆå™¨</h1>
            <p>æœç´¢æ­Œæ›²ï¼Œè·å–çœŸå®çƒ­è¯„ï¼Œç”Ÿæˆä¸“å±æ’ç”»</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <h3>å¡«å†™ä¿¡æ¯</h3>

                <div class="form-group">
                    <label>å¿«é€Ÿæ¨¡æ¿</label>
                    <select id="template" onchange="loadTemplate()">
                        <option value="">é€‰æ‹©æ¨¡æ¿</option>
                        <option value="template1">æ·±å¤œç‹¬ç™½</option>
                        <option value="template2">å¤±çœ å¤œæ™š</option>
                        <option value="template3">å­¤ç‹¬æ—¶åˆ»</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" value="æ·±æµ·é‡Œçš„é±¼" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>

                <div class="form-group">
                    <label for="avatar">å¤´åƒ</label>
                    <input type="file" id="avatar" accept="image/*" style="margin-bottom: 5px;">
                    <small style="color: #666; font-size: 12px;">ä¸ä¸Šä¼ å¤´åƒå°†æ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯</small>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isVip">
                        <label for="isVip">VIPç”¨æˆ·</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="date">æ—¥æœŸ</label>
                    <input type="text" id="date" value="2024å¹´03æœˆ15æ—¥" placeholder="2024å¹´03æœˆ15æ—¥">
                    <button type="button" class="btn" onclick="setToday()">ä½¿ç”¨ä»Šå¤©</button>
                </div>

                <div class="form-group">
                    <label for="hotTag">æ ‡ç­¾</label>
                    <select id="hotTag">
                        <option value="" selected>æ— æ ‡ç­¾</option>
                        <option value="çƒ­è¯„">çƒ­è¯„</option>
                        <option value="ç²¾å½©è¯„è®º">ç²¾å½©è¯„è®º</option>
                        <option value="æœ€æ–°è¯„è®º">æœ€æ–°è¯„è®º</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="songSearch">æœç´¢æ­Œæ›²</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="songSearch" placeholder="è¾“å…¥æ­Œæ›²åæˆ–æ­Œæ‰‹åæœç´¢" style="flex: 1;">
                        <button type="button" class="btn" onclick="searchSong()" id="searchBtn">æœç´¢æ­Œæ›²</button>
                    </div>
                    <small style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">
                        ğŸ’¡ æç¤ºï¼šæœç´¢æ­Œæ›²åå¯é€‰æ‹©"è·å–æ‰€æœ‰è¯„è®º"æˆ–"ä»…çƒ­é—¨è¯„è®º"æ¥ä½¿ç”¨çœŸå®çš„éŸ³ä¹è¯„è®º
                    </small>

                    <!-- CORSé”™è¯¯æç¤º -->
                    <div id="corsWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin: 12px 0;">
                        <h4 style="margin: 0 0 8px 0; color: #856404;">âš ï¸ ç½‘ç»œè®¿é—®å—é™</h4>
                        <p style="margin: 0 0 8px 0; color: #856404; font-size: 14px;">ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶æ— æ³•è®¿é—®éŸ³ä¹APIã€‚</p>
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                            <strong style="color: #495057;">è§£å†³æ–¹æ¡ˆï¼š</strong>
                            <ol style="margin: 4px 0 0 0; padding-left: 20px; color: #495057; font-size: 13px;">
                                <li>æ‰“å¼€å‘½ä»¤è¡Œ/ç»ˆç«¯</li>
                                <li>è¿›å…¥é¡¹ç›®ç›®å½•</li>
                                <li>è¿è¡Œï¼š<code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">python server.py</code></li>
                                <li>è®¿é—®ï¼š<a href="http://localhost:8000" target="_blank" style="color: #007bff;">http://localhost:8000</a></li>
                            </ol>
                        </div>
                        <button onclick="hideCorsWarning()" style="background: #ffc107; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">æˆ‘çŸ¥é“äº†</button>
                    </div>

                    <div id="songResults" class="song-results"></div>
                    <div id="selectedSong" class="selected-song">
                        <div class="selected-song-info">
                            <img id="selectedSongCover" class="selected-song-cover" src="" alt="æ­Œæ›²å°é¢">
                            <div class="selected-song-details">
                                <h4 id="selectedSongName"></h4>
                                <p id="selectedSongArtist"></p>
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="clearSelectedSong()" style="margin-top: 8px;">æ¸…é™¤é€‰æ‹©</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="content">è¯„è®ºå†…å®¹</label>
                    <textarea id="content" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" rows="4">å‡Œæ™¨ä¸‰ç‚¹çš„é›¨å£°ï¼Œåƒæäº†æˆ‘å†…å¿ƒçš„ç‹¬ç™½</textarea>
                </div>

                <div class="form-group">
                    <label for="likes">ç‚¹èµæ•°</label>
                    <input type="number" id="likes" value="2847" placeholder="2847" min="0">
                </div>
            </div>
            
            <div class="preview-section">
                <h3 style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    background-clip: text;
                    font-weight: 600;
                    margin-bottom: 16px;
                    text-align: center;
                ">ğŸ¬ æŠ–éŸ³æµ·æŠ¥é¢„è§ˆ</h3>

                <!-- æµ·æŠ¥å°ºå¯¸é€‰æ‹© -->
                <div style="
                    display: flex;
                    justify-content: center;
                    gap: 12px;
                    margin-bottom: 16px;
                ">
                    <button onclick="setPosterSize('vertical')" id="verticalBtn" style="
                        padding: 8px 16px;
                        border: 2px solid #667eea;
                        background: #667eea;
                        color: white;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: all 0.3s ease;
                    ">ğŸ“± ç«–å± (9:16)</button>
                    <button onclick="setPosterSize('square')" id="squareBtn" style="
                        padding: 8px 16px;
                        border: 2px solid #667eea;
                        background: transparent;
                        color: #667eea;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 12px;
                        transition: all 0.3s ease;
                    ">â¬œ æ–¹å½¢ (1:1)</button>
                </div>
                <!-- æµ·æŠ¥å®¹å™¨ -->
                <div class="poster-container" id="posterContainer" style="
                    width: 300px;
                    height: 533px;
                    margin: 0 auto;
                    position: relative;
                    border-radius: 24px;
                    overflow: hidden;
                    box-shadow:
                        0 25px 70px rgba(0,0,0,0.25),
                        0 10px 30px rgba(0,0,0,0.15),
                        0 0 0 1px rgba(255,255,255,0.1);
                    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                    backdrop-filter: blur(10px);
                " onmouseover="this.style.transform='scale(1.03) translateY(-5px)'; this.style.boxShadow='0 35px 90px rgba(0,0,0,0.35), 0 15px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.2)';"
                   onmouseout="this.style.transform='scale(1) translateY(0px)'; this.style.boxShadow='0 25px 70px rgba(0,0,0,0.25), 0 10px 30px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.1)';">

                    <!-- æ­Œæ›²å°é¢èƒŒæ™¯ -->
                    <div id="backgroundCover" style="
                        position: absolute;
                        top: -5%;
                        left: -5%;
                        right: -5%;
                        bottom: -5%;
                        background-image: url('');
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        opacity: 0;
                        transform: scale(1.1);
                        filter: blur(1px) brightness(0.9) saturate(1.2);
                        transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
                        z-index: 1;
                    "></div>

                    <!-- åŠ¨æ€èƒŒæ™¯ï¼ˆå¤‡ç”¨ï¼‰ -->
                    <div id="fallbackBackground" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg,
                            #ff9a9e 0%,
                            #fecfef 25%,
                            #fecfef 50%,
                            #ffc3a0 75%,
                            #ff9a9e 100%);
                        background-size: 400% 400%;
                        animation: gradientShift 12s ease infinite;
                        opacity: 1;
                        transform: scale(1);
                        transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
                        z-index: 0;
                    "></div>

                    <!-- æ¯›ç»ç’ƒé®ç½©å±‚ -->
                    <div id="glassOverlay" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg,
                            rgba(255, 255, 255, 0.15) 0%,
                            rgba(248, 250, 252, 0.1) 20%,
                            rgba(240, 245, 251, 0.05) 50%,
                            rgba(235, 240, 248, 0.1) 80%,
                            rgba(255, 255, 255, 0.2) 100%);
                        backdrop-filter: blur(20px) saturate(1.2) brightness(1.05) contrast(1.05);
                        z-index: 2;
                    "></div>

                    <!-- è‰²å½©å¢å¼ºå±‚ -->
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background:
                            radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
                            radial-gradient(circle at 75% 75%, rgba(118, 75, 162, 0.08) 0%, transparent 50%),
                            linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
                        mix-blend-mode: overlay;
                        z-index: 2.5;
                    "></div>

                    <!-- çº¹ç†å åŠ  -->
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background:
                            radial-gradient(circle at 30% 20%, rgba(255,255,255,0.3) 0%, transparent 50%),
                            radial-gradient(circle at 70% 80%, rgba(255,255,255,0.25) 0%, transparent 50%),
                            linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
                        animation: float 15s ease-in-out infinite;
                        z-index: 3;
                    "></div>

                    <!-- è£…é¥°å›¾æ¡ˆ -->
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-image:
                            radial-gradient(circle at 20% 20%, rgba(255,255,255,0.15) 0%, transparent 50%),
                            radial-gradient(circle at 80% 80%, rgba(255,255,255,0.15) 0%, transparent 50%),
                            radial-gradient(circle at 40% 60%, rgba(255,255,255,0.1) 0%, transparent 50%);
                        animation: float 10s ease-in-out infinite;
                        z-index: 4;
                    "></div>

                    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
                    <div class="comment-card" id="commentCard" style="
                        position: relative;
                        height: 100%;
                        padding: 40px 30px;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                        z-index: 5;
                    ">
                    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        margin-bottom: 30px;
                        animation: slideInFromTop 0.8s cubic-bezier(0.4, 0, 0.2, 1);
                    ">
                        <!-- å¤´åƒ -->
                        <div id="avatarDisplay" style="
                            width: 56px;
                            height: 56px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 20px;
                            font-weight: 700;
                            flex-shrink: 0;
                            box-shadow:
                                0 8px 25px rgba(102, 126, 234, 0.3),
                                0 0 0 3px rgba(255,255,255,0.8),
                                inset 0 2px 0 rgba(255,255,255,0.3);
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            position: relative;
                            overflow: hidden;
                        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.4), 0 0 0 4px rgba(255,255,255,0.9), inset 0 2px 0 rgba(255,255,255,0.4)';"
                           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.3), 0 0 0 3px rgba(255,255,255,0.8), inset 0 2px 0 rgba(255,255,255,0.3)';">
                            æ·±

                            <!-- å¤´åƒå…‰ç¯ -->
                            <div style="
                                position: absolute;
                                top: -3px;
                                left: -3px;
                                right: -3px;
                                bottom: -3px;
                                border-radius: 50%;
                                background: conic-gradient(from 0deg, #667eea, #764ba2, #667eea);
                                animation: rotate 4s linear infinite;
                                opacity: 0.6;
                                z-index: -1;
                            "></div>
                        </div>

                        <!-- ç”¨æˆ·ä¿¡æ¯ -->
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <!-- ç”¨æˆ·å -->
                                <span id="usernameDisplay" style="
                                    color: #2c3e50;
                                    font-size: 17px;
                                    font-weight: 800;
                                    text-shadow: 0 1px 3px rgba(255,255,255,0.8);
                                    letter-spacing: 0.3px;
                                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    background-clip: text;
                                ">æ·±æµ·é‡Œçš„é±¼</span>

                                <!-- VIPæ ‡è¯† -->
                                <span id="vipBadge" style="
                                    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                                    color: white;
                                    font-size: 9px;
                                    padding: 4px 8px;
                                    border-radius: 10px;
                                    font-weight: 700;
                                    display: none;
                                    box-shadow:
                                        0 3px 10px rgba(243, 156, 18, 0.4),
                                        inset 0 1px 0 rgba(255,255,255,0.3);
                                    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                                    animation: pulse 2s ease-in-out infinite;
                                    letter-spacing: 0.5px;
                                ">ğŸ‘‘ VIP</span>

                                <!-- çƒ­è¯„æ ‡ç­¾ -->
                                <span id="hotTagDisplay" style="
                                    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                                    color: white;
                                    font-size: 9px;
                                    padding: 4px 8px;
                                    border-radius: 10px;
                                    font-weight: 700;
                                    display: none;
                                    box-shadow:
                                        0 3px 10px rgba(231, 76, 60, 0.4),
                                        inset 0 1px 0 rgba(255,255,255,0.3);
                                    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                                    animation: bounce 1s ease-in-out infinite alternate;
                                    letter-spacing: 0.5px;
                                ">ğŸ”¥ çƒ­è¯„</span>
                            </div>

                            <!-- æ—¥æœŸå’Œç‚¹èµ -->
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 6px;">
                                <span id="dateDisplay" style="
                                    color: rgba(44, 62, 80, 0.7);
                                    font-size: 11px;
                                    font-weight: 500;
                                    background: rgba(255,255,255,0.6);
                                    padding: 3px 8px;
                                    border-radius: 12px;
                                    backdrop-filter: blur(10px);
                                    border: 1px solid rgba(255,255,255,0.8);
                                ">2024å¹´03æœˆ15æ—¥</span>

                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 4px;
                                    background: linear-gradient(135deg, rgba(231, 76, 60, 0.9) 0%, rgba(192, 57, 43, 0.9) 100%);
                                    padding: 5px 10px;
                                    border-radius: 15px;
                                    backdrop-filter: blur(10px);
                                    box-shadow:
                                        0 3px 10px rgba(231, 76, 60, 0.3),
                                        inset 0 1px 0 rgba(255,255,255,0.3);
                                    transition: all 0.3s ease;
                                    cursor: pointer;
                                " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(231, 76, 60, 0.4), inset 0 1px 0 rgba(255,255,255,0.4)';"
                                   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(231, 76, 60, 0.3), inset 0 1px 0 rgba(255,255,255,0.3)';">
                                    <span style="font-size: 12px;">â¤ï¸</span>
                                    <span id="likesDisplay" style="
                                        color: white;
                                        font-size: 11px;
                                        font-weight: 700;
                                        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                                        letter-spacing: 0.3px;
                                    ">2847</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸­å¿ƒè¯„è®ºå†…å®¹ -->
                    <div style="
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        text-align: center;
                        padding: 30px 20px;
                        position: relative;
                        animation: fadeInScale 1s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
                    ">
                        <!-- è£…é¥°èƒŒæ™¯ -->
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            width: 200px;
                            height: 200px;
                            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                            border-radius: 50%;
                            animation: pulse 4s ease-in-out infinite;
                        "></div>

                        <!-- é¡¶éƒ¨å¼•å· -->
                        <div style="
                            font-size: 40px;
                            color: rgba(44, 62, 80, 0.2);
                            line-height: 1;
                            margin-bottom: 15px;
                            font-family: 'Georgia', serif;
                            font-weight: bold;
                            animation: float 6s ease-in-out infinite;
                        ">"</div>

                        <!-- è¯„è®ºæ–‡å­— -->
                        <div id="contentDisplay" style="
                            color: #2c3e50;
                            font-size: 19px;
                            line-height: 1.9;
                            font-weight: 700;
                            text-shadow: 0 2px 4px rgba(255,255,255,0.9), 0 1px 2px rgba(0,0,0,0.1);
                            letter-spacing: 0.8px;
                            margin-bottom: 15px;
                            padding: 0 15px;
                            position: relative;
                            z-index: 2;
                            background: linear-gradient(135deg, #1a252f 0%, #2c3e50 30%, #34495e 70%, #2c3e50 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            animation: fadeInUp 1.2s cubic-bezier(0.4, 0, 0.2, 1) 0.5s both;
                            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
                            text-align: center;
                            max-width: 90%;
                            margin-left: auto;
                            margin-right: auto;
                        ">
                            å‡Œæ™¨ä¸‰ç‚¹çš„é›¨å£°ï¼Œåƒæäº†æˆ‘å†…å¿ƒçš„ç‹¬ç™½
                        </div>

                        <!-- åº•éƒ¨å¼•å· -->
                        <div style="
                            font-size: 40px;
                            color: rgba(44, 62, 80, 0.2);
                            line-height: 1;
                            font-family: 'Georgia', serif;
                            font-weight: bold;
                            transform: rotate(180deg);
                            animation: float 6s ease-in-out infinite 3s;
                        ">"</div>
                    </div>

                    <!-- åº•éƒ¨æ­Œæ›²ä¿¡æ¯ -->
                    <div id="songSection" style="
                        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.9) 100%);
                        backdrop-filter: blur(20px);
                        border-radius: 18px;
                        padding: 16px;
                        display: none;
                        align-items: flex-start;
                        gap: 12px;
                        border: 1px solid rgba(255,255,255,0.8);
                        box-shadow:
                            0 8px 25px rgba(0,0,0,0.1),
                            inset 0 1px 0 rgba(255,255,255,0.8);
                        animation: slideInFromBottom 1s cubic-bezier(0.4, 0, 0.2, 1) 0.8s both;
                        position: relative;
                        overflow: hidden;
                        min-height: 65px;
                    ">
                        <!-- æ­Œæ›²å°é¢ -->
                        <div style="
                            position: relative;
                            overflow: hidden;
                            border-radius: 12px;
                            flex-shrink: 0;
                            margin-top: 2px;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        " onmouseover="this.style.transform='scale(1.05) rotate(2deg)'; this.style.zIndex='10';"
                           onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.zIndex='1';">

                            <!-- å¤–å±‚å…‰ç¯æ•ˆæœ -->
                            <div style="
                                position: absolute;
                                top: -3px;
                                left: -3px;
                                right: -3px;
                                bottom: -3px;
                                border-radius: 15px;
                                background: conic-gradient(from 0deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #667eea);
                                animation: rotate 4s linear infinite;
                                opacity: 0.6;
                                z-index: -1;
                            "></div>

                            <!-- å†…å±‚ç™½è‰²è¾¹æ¡† -->
                            <div style="
                                position: absolute;
                                top: -1px;
                                left: -1px;
                                right: -1px;
                                bottom: -1px;
                                border-radius: 13px;
                                background: white;
                                z-index: 0;
                            "></div>

                            <!-- é»‘èƒ¶å”±ç‰‡èƒŒæ™¯ -->
                            <div style="
                                position: absolute;
                                top: 2px;
                                left: 2px;
                                width: 46px;
                                height: 46px;
                                border-radius: 50%;
                                background:
                                    radial-gradient(circle at center,
                                        transparent 8px,
                                        #1a1a1a 8px,
                                        #1a1a1a 10px,
                                        transparent 10px,
                                        transparent 12px,
                                        #1a1a1a 12px,
                                        #1a1a1a 14px,
                                        transparent 14px),
                                    conic-gradient(from 0deg, #2a2a2a, #1a1a1a, #2a2a2a, #1a1a1a);
                                z-index: 0;
                                animation: vinylSpin 8s linear infinite;
                                opacity: 0.3;
                            "></div>

                            <!-- å°é¢å›¾ç‰‡ -->
                            <img id="cardSongCover" style="
                                width: 50px;
                                height: 50px;
                                border-radius: 12px;
                                object-fit: cover;
                                position: relative;
                                z-index: 1;
                                box-shadow:
                                    0 8px 25px rgba(0,0,0,0.2),
                                    inset 0 1px 0 rgba(255,255,255,0.3);
                                transition: all 0.3s ease;
                            " src="" alt="æ­Œæ›²å°é¢"
                               onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 12px 35px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4)';"
                               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.3)';">

                            <!-- CDå…‰ç›˜æ•ˆæœ -->
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 50px;
                                height: 50px;
                                border-radius: 12px;
                                background:
                                    conic-gradient(from 0deg,
                                        transparent,
                                        rgba(255,255,255,0.1),
                                        transparent,
                                        rgba(255,255,255,0.1),
                                        transparent);
                                z-index: 2;
                                animation: vinylSpin 6s linear infinite reverse;
                                opacity: 0.5;
                                pointer-events: none;
                            "></div>

                            <!-- åå…‰æ•ˆæœ -->
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 30%, transparent 70%, rgba(255,255,255,0.2) 100%);
                                border-radius: 12px;
                                pointer-events: none;
                                z-index: 2;
                            "></div>

                            <!-- æ’­æ”¾å›¾æ ‡è¦†ç›–å±‚ -->
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 12px;
                                opacity: 0.8;
                                z-index: 5;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.opacity='1'; this.style.background='radial-gradient(circle, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.6) 100%)';"
                               onmouseout="this.style.opacity='0.8'; this.style.background='radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 100%)';">

                                <!-- æ’­æ”¾æŒ‰é’® -->
                                <div style="
                                    width: 18px;
                                    height: 18px;
                                    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow:
                                        0 3px 10px rgba(0,0,0,0.3),
                                        inset 0 1px 0 rgba(255,255,255,0.5);
                                    transition: all 0.3s ease;
                                    animation: pulse 2.5s ease-in-out infinite;
                                " onmouseover="this.style.transform='scale(1.15)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.6)';"
                                   onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.5)';">
                                    <div style="
                                        width: 0;
                                        height: 0;
                                        border-left: 5px solid #333;
                                        border-top: 3px solid transparent;
                                        border-bottom: 3px solid transparent;
                                        margin-left: 1px;
                                    "></div>
                                </div>
                            </div>

                            <!-- éŸ³ç¬¦è£…é¥° -->
                            <div style="
                                position: absolute;
                                top: -8px;
                                right: -8px;
                                width: 16px;
                                height: 16px;
                                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 8px;
                                color: white;
                                box-shadow: 0 2px 8px rgba(240, 147, 251, 0.4);
                                animation: musicNote 3s ease-in-out infinite;
                                z-index: 4;
                            ">â™ª</div>
                        </div>

                        <!-- æ­Œæ›²ä¿¡æ¯ -->
                        <div style="flex: 1; min-width: 0; max-width: calc(100% - 120px);">
                            <div id="cardSongName" style="
                                color: #2c3e50;
                                font-size: 13px;
                                font-weight: 700;
                                margin-bottom: 4px;
                                text-shadow: 0 1px 2px rgba(255,255,255,0.8);
                                line-height: 1.2;
                                word-wrap: break-word;
                                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                overflow: hidden;
                            "></div>
                            <div id="cardSongArtist" style="
                                color: rgba(44, 62, 80, 0.7);
                                font-size: 10px;
                                font-weight: 500;
                                line-height: 1.2;
                                word-wrap: break-word;
                                height: 24px;
                                display: flex;
                                align-items: center;
                                overflow: hidden;
                            "></div>
                        </div>

                        <!-- æ­Œæ›²è¯¦ç»†ä¿¡æ¯ -->
                        <div style="
                            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
                            border: 1px solid rgba(102, 126, 234, 0.2);
                            border-radius: 12px;
                            padding: 8px 12px;
                            flex-shrink: 0;
                            align-self: flex-start;
                            margin-top: 2px;
                            height: fit-content;
                            backdrop-filter: blur(10px);
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%)'; this.style.transform='scale(1.02)';"
                           onmouseout="this.style.background='linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)'; this.style.transform='scale(1)';">

                            <!-- ä¸“è¾‘ä¿¡æ¯ -->
                            <div style="
                                color: #667eea;
                                font-size: 8px;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                margin-bottom: 2px;
                                opacity: 0.8;
                            ">ALBUM</div>

                            <!-- ä¸“è¾‘åç§° -->
                            <div id="cardAlbumName" style="
                                color: #2c3e50;
                                font-size: 9px;
                                font-weight: 700;
                                line-height: 1.2;
                                max-width: 80px;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                white-space: nowrap;
                                margin-bottom: 3px;
                            ">æœªçŸ¥ä¸“è¾‘</div>

                            <!-- éŸ³ä¹ç±»å‹æ ‡ç­¾ -->
                            <div style="
                                display: flex;
                                align-items: center;
                                gap: 3px;
                            ">
                                <div style="
                                    width: 6px;
                                    height: 6px;
                                    border-radius: 50%;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    animation: pulse 2s ease-in-out infinite;
                                "></div>
                                <span style="
                                    color: #7f8c8d;
                                    font-size: 7px;
                                    font-weight: 500;
                                    letter-spacing: 0.3px;
                                ">MUSIC</span>
                            </div>
                        </div>
                    </div>
                </div>





                    <div class="comment-footer">
                        <span class="reply-count">44æ¡å›å¤ ></span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="export-btn" onclick="exportImage()">
                        é•¿æŒ‰ä¿å­˜å›¾ç‰‡
                    </button>
                    <button class="export-btn" onclick="generateVideo()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        ğŸ¬ ç”Ÿæˆè§†é¢‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨é€‰ä¸­çš„æ­Œæ›²ä¿¡æ¯
        let selectedSongData = null;

        // å…¨å±€å˜é‡å­˜å‚¨é€‰ä¸­çš„è¯„è®ºå’Œæ­Œæ›²ä¿¡æ¯ï¼ˆç”¨äºé¢„è§ˆï¼‰
        let selectedComment = null;
        let selectedSong = null;

        // ç½‘æ˜“äº‘éŸ³ä¹APIé…ç½®
        const NETEASE_API_BASE = 'https://netease-cloud-music-api-omega-seven.vercel.app';

        // å¤‡ç”¨APIåœ°å€ï¼ˆå¦‚æœä¸»APIä¸å¯ç”¨ï¼‰
        const BACKUP_API_BASES = [
            'https://netease-cloud-music-api-psi-six.vercel.app',
            'https://music-api-sigma-five.vercel.app',
            'https://netease-music-api-ten.vercel.app',
            'https://netease-music-api.vercel.app',
            'https://music-api.heheda.top',
            'https://netease-cloud-music-api-rust-tau.vercel.app',
            'https://music.eleuu.com'
        ];

        // å½“å‰ä½¿ç”¨çš„APIåœ°å€
        let currentApiBase = NETEASE_API_BASE;

        // å¤„ç†å›¾ç‰‡è·¨åŸŸé—®é¢˜çš„ä»£ç†å‡½æ•°
        function getProxiedImageUrl(originalUrl) {
            if (!originalUrl) return null;
            try {
                // ä½¿ç”¨å›¾ç‰‡ä»£ç†æœåŠ¡è§£å†³è·¨åŸŸé—®é¢˜
                return `https://images.weserv.nl/?url=${encodeURIComponent(originalUrl)}&w=200&h=200&fit=cover&output=jpg`;
            } catch (error) {
                console.warn('å›¾ç‰‡ä»£ç†å¤±è´¥:', error);
                return null;
            }
        }

        // æ ¹æ®ç½‘æ˜“äº‘éŸ³ä¹çš„picIdç”Ÿæˆå›¾ç‰‡URL
        function getNeteaseImageUrl(picId, size = 200) {
            if (!picId) return null;
            // ç½‘æ˜“äº‘éŸ³ä¹å›¾ç‰‡URLæ ¼å¼
            const baseUrl = `https://p1.music.126.net/${picId}/${picId}.jpg`;
            return getProxiedImageUrl(baseUrl);
        }

        // ç”Ÿæˆé«˜è´¨é‡ä¸“è¾‘å°é¢
        function generateFallbackCover(songName, artistName) {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');

            // æ ¹æ®æ­Œæ›²åå’Œæ­Œæ‰‹åç”Ÿæˆç‹¬ç‰¹çš„é¢œè‰²
            const hash = (songName + artistName).split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);

            // emoé£æ ¼çš„é…è‰²æ–¹æ¡ˆ
            const colorSchemes = [
                { bg: ['#6c7b7f', '#4a5568'], accent: '#a0aec0', text: '#ffffff' },
                { bg: ['#7d6d75', '#553c4e'], accent: '#b794a8', text: '#ffffff' },
                { bg: ['#7a7a7a', '#4a4a4a'], accent: '#a8a8a8', text: '#ffffff' },
                { bg: ['#8a8a8a', '#5a5a5a'], accent: '#b8b8b8', text: '#ffffff' },
                { bg: ['#6e6e6e', '#3e3e3e'], accent: '#9e9e9e', text: '#ffffff' },
                { bg: ['#8e9aaf', '#5d6d7e'], accent: '#aeb6cf', text: '#ffffff' },
                { bg: ['#9d8189', '#7d5a6b'], accent: '#c4a1aa', text: '#ffffff' }
            ];

            const scheme = colorSchemes[Math.abs(hash) % colorSchemes.length];

            // åˆ›å»ºæ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, scheme.bg[0]);
            gradient.addColorStop(1, scheme.bg[1]);

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 200, 200);

            // æ·»åŠ è£…é¥°æ€§å‡ ä½•å›¾å½¢
            ctx.fillStyle = scheme.accent + '20';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(100, 100, 30 + i * 25, 0, Math.PI * 2);
                ctx.fill();
            }

            // æ·»åŠ éŸ³ä¹ç¬¦å·
            ctx.fillStyle = scheme.accent + '60';
            ctx.font = 'bold 40px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const musicSymbols = ['â™ª', 'â™«', 'â™¬', 'â™­', 'â™¯', 'ğ„'];
            const symbol = musicSymbols[Math.abs(hash) % musicSymbols.length];
            ctx.fillText(symbol, 100, 70);

            // æ·»åŠ æ­Œæ›²åé¦–å­—æ¯
            ctx.fillStyle = scheme.text;
            ctx.font = 'bold 36px sans-serif';
            const firstChar = songName.charAt(0).toUpperCase();
            ctx.fillText(firstChar, 100, 120);

            // æ·»åŠ æ­Œæ‰‹åé¦–å­—æ¯ï¼ˆå°å­—ï¼‰
            ctx.fillStyle = scheme.accent;
            ctx.font = 'bold 16px sans-serif';
            const artistChar = artistName.charAt(0).toUpperCase();
            ctx.fillText(artistChar, 100, 150);

            // æ·»åŠ è¾¹æ¡†
            ctx.strokeStyle = scheme.accent + '40';
            ctx.lineWidth = 2;
            ctx.strokeRect(5, 5, 190, 190);

            return canvas.toDataURL();
        }

        // å°è¯•ä¸åŒçš„APIåœ°å€
        async function tryApiRequest(endpoint, params = {}) {
            const apis = [currentApiBase, ...BACKUP_API_BASES];

            for (const apiBase of apis) {
                try {
                    const url = new URL(endpoint, apiBase);
                    Object.keys(params).forEach(key => {
                        if (params[key] !== undefined && params[key] !== null) {
                            url.searchParams.append(key, params[key]);
                        }
                    });

                    console.log('å°è¯•APIè¯·æ±‚:', url.toString());

                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('APIè¯·æ±‚æˆåŠŸ:', apiBase);
                        currentApiBase = apiBase; // æ›´æ–°å½“å‰å¯ç”¨çš„API
                        return data;
                    } else {
                        console.warn(`API ${apiBase} è¿”å›é”™è¯¯çŠ¶æ€:`, response.status, response.statusText);
                    }
                } catch (error) {
                    console.warn(`API ${apiBase} è¯·æ±‚å¤±è´¥:`, error.message);

                    // å¦‚æœæ˜¯CORSé”™è¯¯ï¼Œç»™å‡ºç‰¹åˆ«æç¤º
                    if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        console.warn('CORSé”™è¯¯ - å»ºè®®ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œ');
                    }
                    continue;
                }
            }

            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯å’ŒCORSè­¦å‘Š
            const errorMsg = 'æ‰€æœ‰APIéƒ½ä¸å¯ç”¨ã€‚è¯·å°è¯•ï¼š\n1. è¿è¡Œæœ¬åœ°æœåŠ¡å™¨: python server.py\n2. ç„¶åè®¿é—®: http://localhost:8000';
            console.error(errorMsg);
            showCorsWarning();
            throw new Error(errorMsg);
        }

        // æ˜¾ç¤ºCORSè­¦å‘Š
        function showCorsWarning() {
            const warning = document.getElementById('corsWarning');
            if (warning) {
                warning.style.display = 'block';
            }
        }

        // éšè—CORSè­¦å‘Š
        function hideCorsWarning() {
            const warning = document.getElementById('corsWarning');
            if (warning) {
                warning.style.display = 'none';
            }
        }

        // æœç´¢æ­Œæ›²åŠŸèƒ½
        async function searchSong() {
            const query = document.getElementById('songSearch').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            console.log('å¼€å§‹æœç´¢:', query);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.textContent;
            searchBtn.textContent = 'æœç´¢ä¸­...';
            searchBtn.disabled = true;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsContainer = document.getElementById('songResults');
            resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #6c757d;">ğŸµ æ­£åœ¨æœç´¢æ­Œæ›²ï¼Œè¯·ç¨å€™...</div>';
            resultsContainer.style.display = 'block';

            try {
                // è°ƒç”¨ç½‘æ˜“äº‘éŸ³ä¹æœç´¢API
                const data = await tryApiRequest('/search', {
                    keywords: query,
                    type: 1, // 1è¡¨ç¤ºæœç´¢æ­Œæ›²
                    limit: 10
                });

                if (data && data.result && data.result.songs && data.result.songs.length > 0) {
                    const songs = data.result.songs.map(song => {
                        // å¤„ç†æ­Œæ‰‹ä¿¡æ¯
                        const artists = song.artists || [];
                        const artistNames = artists.map(artist => artist.name).join('/');

                        // ç”Ÿæˆé«˜è´¨é‡å°é¢
                        const firstArtist = artists[0] ? artists[0].name : 'æœªçŸ¥æ­Œæ‰‹';
                        const generatedCover = generateFallbackCover(song.name, firstArtist);

                        return {
                            id: song.id,
                            name: song.name,
                            artist: artistNames,
                            album: song.album ? song.album.name : 'æœªçŸ¥ä¸“è¾‘',
                            cover: generatedCover, // ç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„é«˜è´¨é‡å°é¢
                            fallbackCover: generatedCover,
                            duration: song.duration,
                            picId: song.album ? song.album.picId : null
                        };
                    });

                    console.log('æœç´¢åˆ°æ­Œæ›²:', songs.length, 'é¦–');
                    console.log('æ­Œæ›²æ•°æ®:', songs);
                    displaySearchResults(songs);
                } else {
                    console.log('APIè¿”å›æ•°æ®:', data);
                    throw new Error('æœç´¢ç»“æœä¸ºç©º');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #6c757d; background: white; border-radius: 8px;">
                        <div style="font-size: 16px; margin-bottom: 12px;">ğŸ˜” æœç´¢å¤±è´¥</div>
                        <div style="font-size: 12px; color: #adb5bd; margin-bottom: 16px;">
                            å¯èƒ½çš„åŸå› ï¼šç½‘ç»œè¿æ¥é—®é¢˜æˆ–APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨<br>
                            <small>é”™è¯¯è¯¦æƒ…: ${error.message}</small>
                        </div>
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <button onclick="searchSong()" style="padding: 8px 16px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•æœç´¢</button>
                            <button onclick="testSearch()" style="padding: 8px 16px; font-size: 12px; background: #868e96; color: white; border: none; border-radius: 4px; cursor: pointer;">æµ‹è¯•æœç´¢</button>
                        </div>
                    </div>
                `;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                searchBtn.textContent = originalText;
                searchBtn.disabled = false;
            }
        }

        // æµ‹è¯•æœç´¢åŠŸèƒ½
        async function testSearch() {
            document.getElementById('songSearch').value = 'å­¤ç‹¬æ‚£è€…';
            await searchSong();
        }

        // æµ‹è¯•é¡µé¢åŠŸèƒ½
        function testPage() {
            console.log('æµ‹è¯•é¡µé¢åŠŸèƒ½');
            console.log('songResults å…ƒç´ :', document.getElementById('songResults'));
            console.log('å½“å‰æœç´¢ç»“æœ:', window.currentSearchResults);
            console.log('é€‰ä¸­çš„æ­Œæ›²:', selectedSongData);

            // æµ‹è¯•é€‰æ‹©ç¬¬ä¸€é¦–æ­Œ
            if (window.currentSearchResults && window.currentSearchResults.length > 0) {
                console.log('æµ‹è¯•é€‰æ‹©ç¬¬ä¸€é¦–æ­Œ');
                selectSongFromResults(0);
            } else {
                console.log('æ²¡æœ‰æœç´¢ç»“æœå¯ä¾›æµ‹è¯•');
            }
        }

        // å¤„ç†å›¾ç‰‡åŠ è½½æˆåŠŸ
        function handleImageLoad(img) {
            const originalUrl = img.getAttribute('data-original');
            if (originalUrl && img.src !== originalUrl) {
                // å°è¯•å¤šç§æ–¹å¼åŠ è½½ç½‘æ˜“äº‘å›¾ç‰‡
                tryLoadNeteaseImage(img, originalUrl);
            }
        }

        // å°è¯•åŠ è½½ç½‘æ˜“äº‘éŸ³ä¹å›¾ç‰‡
        function tryLoadNeteaseImage(img, originalUrl) {
            if (!originalUrl) return;

            // æå–picId
            const picIdMatch = originalUrl.match(/\/(\d+)\/\d+\.jpg/);
            if (!picIdMatch) return;

            const picId = picIdMatch[1];
            console.log('å°è¯•åŠ è½½å›¾ç‰‡ï¼ŒpicId:', picId);

            // å°è¯•ä¸åŒçš„æ–¹æ³•
            const methods = [
                // æ–¹æ³•1: ç›´æ¥ä½¿ç”¨ç½‘æ˜“äº‘URL
                `https://p1.music.126.net/${picId}/${picId}.jpg?param=200y200`,
                `https://p2.music.126.net/${picId}/${picId}.jpg?param=200y200`,
                // æ–¹æ³•2: ä½¿ç”¨ä¸åŒçš„ä»£ç†æœåŠ¡
                `https://images.weserv.nl/?url=p1.music.126.net/${picId}/${picId}.jpg&w=200&h=200`,
                `https://cors-anywhere.herokuapp.com/https://p1.music.126.net/${picId}/${picId}.jpg`,
                // æ–¹æ³•3: ä½¿ç”¨å…¶ä»–CDN
                `https://music.163.com/api/img/blur/${picId}`
            ];

            let currentIndex = 0;

            function tryNext() {
                if (currentIndex >= methods.length) {
                    console.log('æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨fallback');
                    return;
                }

                const testImg = new Image();
                testImg.crossOrigin = 'anonymous';
                testImg.onload = function() {
                    img.src = methods[currentIndex];
                    console.log('å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ–¹æ³•:', currentIndex + 1, methods[currentIndex]);
                };
                testImg.onerror = function() {
                    console.log('æ–¹æ³•', currentIndex + 1, 'å¤±è´¥:', methods[currentIndex]);
                    currentIndex++;
                    tryNext();
                };
                testImg.src = methods[currentIndex];
            }

            tryNext();
        }

        // å¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥
        function handleImageError(img) {
            const fallbackUrl = img.getAttribute('data-fallback');
            if (fallbackUrl && img.src !== fallbackUrl) {
                img.src = fallbackUrl;
                console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°fallback:', fallbackUrl);
            }
        }

        // åŠ è½½çœŸå®å°é¢
        function loadRealCovers() {
            if (!window.currentSearchResults) return;

            const images = document.querySelectorAll('.song-cover[data-original]');
            images.forEach((img, index) => {
                const song = window.currentSearchResults[index];
                if (song && song.picId) {
                    // å°è¯•åŠ è½½ç½‘æ˜“äº‘éŸ³ä¹å°é¢
                    loadNeteaseImage(img, song.picId);
                }
            });
        }

        // åŠ è½½ç½‘æ˜“äº‘éŸ³ä¹å›¾ç‰‡
        function loadNeteaseImage(img, picId) {
            if (!picId) return;

            console.log('å°è¯•åŠ è½½å°é¢ï¼ŒpicId:', picId);

            // ç½‘æ˜“äº‘éŸ³ä¹å›¾ç‰‡URLï¼ˆæ·»åŠ å‚æ•°æ¥æŒ‡å®šå°ºå¯¸ï¼‰
            const imageUrl = `https://p1.music.126.net/${picId}/${picId}.jpg?param=200y200`;

            // åˆ›å»ºä¸€ä¸ªæ–°çš„Imageå¯¹è±¡æ¥æµ‹è¯•åŠ è½½
            const testImg = new Image();
            testImg.crossOrigin = 'anonymous';

            testImg.onload = function() {
                // åŠ è½½æˆåŠŸï¼Œæ›´æ–°æ˜¾ç¤ºçš„å›¾ç‰‡
                img.src = imageUrl;
                console.log('å°é¢åŠ è½½æˆåŠŸ:', imageUrl);
            };

            testImg.onerror = function() {
                console.log('å°é¢åŠ è½½å¤±è´¥ï¼Œä¿æŒä½¿ç”¨fallback');
                // å¯ä»¥å°è¯•å…¶ä»–æ–¹æ³•æˆ–ä¿æŒä½¿ç”¨fallback
            };

            testImg.src = imageUrl;
        }

        // è·å–æ­Œæ›²è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬é«˜è´¨é‡å°é¢ï¼‰
        async function getSongDetail(songId) {
            try {
                console.log('ğŸµ å¼€å§‹è·å–æ­Œæ›²è¯¦æƒ…ï¼ŒID:', songId);

                const data = await tryApiRequest('/song/detail', {
                    ids: songId
                });

                console.log('ğŸµ æ­Œæ›²è¯¦æƒ…APIå“åº”:', data);

                if (data && data.songs && data.songs.length > 0) {
                    const song = data.songs[0];
                    const album = song.al || song.album;
                    const artists = song.ar || song.artists || [];

                    // è·å–é«˜è´¨é‡å°é¢
                    let coverUrl = null;
                    if (album && album.picUrl) {
                        // ä½¿ç”¨é«˜è´¨é‡å°é¢URL
                        coverUrl = album.picUrl.replace(/\?param=\d+y\d+/, '?param=300y300');
                        // ä½¿ç”¨ä»£ç†æœåŠ¡è§£å†³è·¨åŸŸé—®é¢˜
                        coverUrl = getProxiedImageUrl(coverUrl);
                    }

                    const songDetail = {
                        id: song.id,
                        name: song.name,
                        artist: artists.map(artist => artist.name).join('/'),
                        album: album ? album.name : 'æœªçŸ¥ä¸“è¾‘',
                        cover: coverUrl,
                        fallbackCover: generateFallbackCover(song.name, artists[0]?.name || 'æœªçŸ¥æ­Œæ‰‹'),
                        duration: song.dt || song.duration,
                        picId: album ? album.pic_str || album.pic : null,
                        picUrl: album ? album.picUrl : null
                    };

                    console.log('è·å–åˆ°æ­Œæ›²è¯¦æƒ…:', songDetail);
                    return songDetail;
                } else {
                    throw new Error('æ­Œæ›²è¯¦æƒ…ä¸ºç©º');
                }

            } catch (error) {
                console.error('è·å–æ­Œæ›²è¯¦æƒ…å¤±è´¥:', error);
                return null;
            }
        }

        // è·å–çƒ­é—¨è¯„è®ºï¼ˆä½¿ç”¨ /comment/hot æ¥å£ï¼‰
        async function getHotComments(songId, limit = 20, offset = 0) {
            try {
                console.log('ğŸ”¥ å¼€å§‹è·å–çƒ­é—¨è¯„è®ºï¼ŒID:', songId, 'limit:', limit, 'offset:', offset);

                const data = await tryApiRequest('/comment/hot', {
                    id: songId,
                    type: 0, // 0è¡¨ç¤ºæ­Œæ›²
                    limit: limit,
                    offset: offset
                });

                console.log('ğŸ”¥ çƒ­é—¨è¯„è®ºAPIå“åº”:', data);

                let hotComments = [];

                // æ£€æŸ¥æ•°æ®ç»“æ„
                console.log('æ£€æŸ¥APIæ•°æ®ç»“æ„:');
                console.log('- dataå­˜åœ¨:', !!data);
                console.log('- data.hotCommentså­˜åœ¨:', !!(data && data.hotComments));
                console.log('- data.hotCommentsé•¿åº¦:', data && data.hotComments ? data.hotComments.length : 'N/A');

                if (data && data.hotComments && data.hotComments.length > 0) {
                    console.log('å¼€å§‹å¤„ç†çƒ­é—¨è¯„è®ºæ•°æ®...');
                    console.log('åŸå§‹è¯„è®ºæ•°æ®ç¤ºä¾‹:', data.hotComments[0]);

                    hotComments = data.hotComments.map((comment, index) => {
                        const processedComment = {
                            content: comment.content,
                            username: comment.user ? comment.user.nickname : 'åŒ¿åç”¨æˆ·',
                            userId: comment.user ? comment.user.userId : 0,
                            avatar: comment.user ? comment.user.avatarUrl : '',
                            likedCount: comment.likedCount || 0,
                            time: comment.time,
                            timeStr: comment.timeStr || formatTime(comment.time),
                            isHot: true // æ ‡è®°ä¸ºçƒ­é—¨è¯„è®º
                        };

                        if (index === 0) {
                            console.log('å¤„ç†åçš„è¯„è®ºç¤ºä¾‹:', processedComment);
                        }

                        return processedComment;
                    });

                    console.log('è¯„è®ºå¤„ç†å®Œæˆï¼Œæ•°é‡:', hotComments.length);
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°çƒ­é—¨è¯„è®ºæ•°æ®');
                }

                // æŒ‰ç‚¹èµæ•°æ’åº
                hotComments.sort((a, b) => b.likedCount - a.likedCount);

                console.log('è·å–åˆ°çƒ­é—¨è¯„è®ºæ•°é‡:', hotComments.length);
                console.log('çƒ­é—¨è¯„è®ºæ•°æ®ç¤ºä¾‹:', hotComments.slice(0, 2));
                return hotComments;

            } catch (error) {
                console.error('è·å–çƒ­é—¨è¯„è®ºå¤±è´¥:', error);
                return [];
            }
        }

        // è·å–æ­Œæ›²è¯„è®ºï¼ˆåŒ…æ‹¬çƒ­é—¨è¯„è®ºå’Œæ™®é€šè¯„è®ºï¼‰
        async function getSongComments(songId, limit = 50, offset = 0) {
            try {
                console.log('ğŸ’¬ å¼€å§‹è·å–æ­Œæ›²è¯„è®ºï¼ŒID:', songId, 'limit:', limit, 'offset:', offset);

                const data = await tryApiRequest('/comment/music', {
                    id: songId,
                    limit: limit,
                    offset: offset
                });

                console.log('ğŸ’¬ æ­Œæ›²è¯„è®ºAPIå“åº”:', data);

                console.log('è¯„è®ºAPIè¿”å›æ•°æ®:', data);

                let allComments = [];

                // è·å–çƒ­é—¨è¯„è®º
                if (data && data.hotComments && data.hotComments.length > 0) {
                    const hotComments = data.hotComments.map(comment => ({
                        content: comment.content,
                        username: comment.user.nickname,
                        userId: comment.user.userId,
                        avatar: comment.user.avatarUrl,
                        likedCount: comment.likedCount,
                        time: comment.time,
                        timeStr: comment.timeStr || formatTime(comment.time),
                        isHot: true // æ ‡è®°ä¸ºçƒ­é—¨è¯„è®º
                    }));
                    allComments = allComments.concat(hotComments);
                }

                // è·å–æ™®é€šè¯„è®º
                if (data && data.comments && data.comments.length > 0) {
                    const normalComments = data.comments.map(comment => ({
                        content: comment.content,
                        username: comment.user.nickname,
                        userId: comment.user.userId,
                        avatar: comment.user.avatarUrl,
                        likedCount: comment.likedCount,
                        time: comment.time,
                        timeStr: comment.timeStr || formatTime(comment.time),
                        isHot: false // æ ‡è®°ä¸ºæ™®é€šè¯„è®º
                    }));
                    allComments = allComments.concat(normalComments);
                }

                // æŒ‰ç‚¹èµæ•°æ’åºï¼Œçƒ­é—¨è¯„è®ºä¼˜å…ˆ
                allComments.sort((a, b) => {
                    if (a.isHot && !b.isHot) return -1;
                    if (!a.isHot && b.isHot) return 1;
                    return b.likedCount - a.likedCount;
                });

                console.log('è·å–åˆ°è¯„è®ºæ•°é‡:', allComments.length);
                return allComments;

            } catch (error) {
                console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                return [];
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results) {
            console.log('æ˜¾ç¤ºæœç´¢ç»“æœ:', results);
            const resultsContainer = document.getElementById('songResults');

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #6c757d;">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            const songsHtml = results.map((song, index) => `
                <div class="song-item" onclick="selectSongFromResults(${index})" style="
                    display: flex;
                    align-items: center;
                    padding: 12px;
                    border-bottom: 1px solid #f1f3f4;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    background: white;
                " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='translateX(4px)'"
                   onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
                    <img class="song-cover"
                         src="${song.cover}"
                         alt="${song.name}"
                         loading="lazy"
                         style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover; flex-shrink: 0; background: #e9ecef;">
                    <div class="song-info" style="flex: 1; margin-left: 12px; min-width: 0;">
                        <div class="song-name" style="font-size: 15px; font-weight: 500; color: #495057; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${song.name}</div>
                        <div class="song-artist" style="font-size: 13px; color: #6c757d; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${song.artist}</div>
                        <div class="song-album" style="font-size: 11px; color: #adb5bd; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${song.album}</div>
                    </div>
                    <div style="margin-left: 12px; padding: 8px; flex-shrink: 0;">
                        <div style="font-size: 12px; color: #6c757d; text-align: center;">ç‚¹å‡»é€‰æ‹©</div>
                    </div>
                </div>
            `).join('');

            resultsContainer.innerHTML = `
                <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="padding: 12px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                        <div style="font-size: 14px; color: #495057; font-weight: 500;">ğŸµ æ‰¾åˆ° ${results.length} é¦–æ­Œæ›²</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 2px;">ç‚¹å‡»æ­Œæ›²è¿›è¡Œé€‰æ‹©</div>
                    </div>
                    ${songsHtml}
                </div>
            `;

            // å­˜å‚¨æœç´¢ç»“æœä¾›åç»­ä½¿ç”¨
            window.currentSearchResults = results;
            resultsContainer.style.display = 'block';

            console.log('æœç´¢ç»“æœå·²æ˜¾ç¤ºï¼Œä½¿ç”¨ç”Ÿæˆçš„é«˜è´¨é‡å°é¢');
        }

        // ä»æœç´¢ç»“æœä¸­é€‰æ‹©æ­Œæ›²
        async function selectSongFromResults(index) {
            console.log('é€‰æ‹©æ­Œæ›²ï¼Œç´¢å¼•:', index);

            if (!window.currentSearchResults || !window.currentSearchResults[index]) {
                console.error('æ— æ•ˆçš„æ­Œæ›²ç´¢å¼•æˆ–æœç´¢ç»“æœ');
                return;
            }

            const song = window.currentSearchResults[index];
            console.log('é€‰ä¸­æ­Œæ›²:', song);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const selectedSong = document.getElementById('selectedSong');
            if (selectedSong) {
                selectedSong.innerHTML = `
                    <div style="padding: 16px; text-align: center; color: #6c757d;">
                        ğŸµ æ­£åœ¨è·å–æ­Œæ›²è¯¦æƒ…å’Œé«˜è´¨é‡å°é¢...
                    </div>
                `;
                selectedSong.style.display = 'block';
            }

            try {
                // è·å–æ­Œæ›²è¯¦ç»†ä¿¡æ¯å’Œé«˜è´¨é‡å°é¢
                const songDetail = await getSongDetail(song.id);

                if (songDetail) {
                    // ä½¿ç”¨è¯¦ç»†ä¿¡æ¯æ›´æ–°æ­Œæ›²æ•°æ®
                    selectedSongData = {
                        ...song,
                        ...songDetail,
                        // å¦‚æœè·å–åˆ°äº†é«˜è´¨é‡å°é¢ï¼Œä½¿ç”¨å®ƒï¼Œå¦åˆ™ä¿æŒåŸæœ‰çš„
                        cover: songDetail.cover || song.cover || song.fallbackCover
                    };
                } else {
                    // å¦‚æœè·å–è¯¦æƒ…å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                    selectedSongData = song;
                }

                console.log('æœ€ç»ˆé€‰ä¸­æ­Œæ›²æ•°æ®:', selectedSongData);

                // æ›´æ–°é€‰ä¸­æ­Œæ›²æ˜¾ç¤º
                const selectedCover = document.getElementById('selectedSongCover');
                if (selectedCover) {
                    selectedCover.src = selectedSongData.cover || selectedSongData.fallbackCover;
                    selectedCover.onerror = () => { selectedCover.src = selectedSongData.fallbackCover; };
                }

                const selectedSongName = document.getElementById('selectedSongName');
                const selectedSongArtist = document.getElementById('selectedSongArtist');

                if (selectedSongName) selectedSongName.textContent = selectedSongData.name;
                if (selectedSongArtist) selectedSongArtist.textContent = selectedSongData.artist;

                // æ›´æ–°è¯„è®ºå¡ç‰‡ä¸­çš„æ­Œæ›²ä¿¡æ¯
                const cardCover = document.getElementById('cardSongCover');
                if (cardCover) {
                    cardCover.src = selectedSongData.cover || selectedSongData.fallbackCover;
                    cardCover.onerror = () => { cardCover.src = selectedSongData.fallbackCover; };
                }

                const cardSongName = document.getElementById('cardSongName');
                const cardSongArtist = document.getElementById('cardSongArtist');
                const cardAlbumName = document.getElementById('cardAlbumName');
                const songSection = document.getElementById('songSection');

                if (cardSongName) {
                    cardSongName.textContent = selectedSongData.name;
                    // è‡ªåŠ¨è°ƒæ•´æ­Œåå­—ä½“å¤§å°
                    setTimeout(() => autoResizeText(cardSongName, 13), 50);
                }
                if (cardSongArtist) {
                    cardSongArtist.textContent = selectedSongData.artist;
                    // è‡ªåŠ¨è°ƒæ•´æ­Œæ‰‹å­—ä½“å¤§å°
                    setTimeout(() => autoResizeText(cardSongArtist, 10), 50);
                }
                if (cardAlbumName) {
                    cardAlbumName.textContent = selectedSongData.album || 'æœªçŸ¥ä¸“è¾‘';
                }
                if (songSection) songSection.style.display = 'flex';

                // æ˜¾ç¤ºè·å–è¯„è®ºçš„ç•Œé¢
                console.log('è°ƒç”¨ showGetCommentsInterface');
                showGetCommentsInterface(selectedSongData);

            } catch (error) {
                console.error('è·å–æ­Œæ›²è¯¦æƒ…æ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨åŸå§‹æ•°æ®
                selectedSongData = song;

                // æ›´æ–°æ˜¾ç¤º
                updateSongDisplay(song);
                showGetCommentsInterface(song);
            }
        }

        // æ›´æ–°æ­Œæ›²æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
        function updateSongDisplay(song) {
            const selectedCover = document.getElementById('selectedSongCover');
            if (selectedCover) {
                selectedCover.src = song.cover || song.fallbackCover;
                selectedCover.onerror = () => { selectedCover.src = song.fallbackCover; };
            }

            const selectedSongName = document.getElementById('selectedSongName');
            const selectedSongArtist = document.getElementById('selectedSongArtist');
            const selectedSong = document.getElementById('selectedSong');

            if (selectedSongName) selectedSongName.textContent = song.name;
            if (selectedSongArtist) selectedSongArtist.textContent = song.artist;
            if (selectedSong) selectedSong.style.display = 'block';

            const cardCover = document.getElementById('cardSongCover');
            if (cardCover) {
                cardCover.src = song.cover || song.fallbackCover;
                cardCover.onerror = () => { cardCover.src = song.fallbackCover; };
            }

            const cardSongName = document.getElementById('cardSongName');
            const cardSongArtist = document.getElementById('cardSongArtist');
            const cardAlbumName = document.getElementById('cardAlbumName');
            const songSection = document.getElementById('songSection');

            if (cardSongName) {
                cardSongName.textContent = song.name;
                setTimeout(() => autoResizeText(cardSongName, 13), 50);
            }
            if (cardSongArtist) {
                cardSongArtist.textContent = song.artist;
                setTimeout(() => autoResizeText(cardSongArtist, 10), 50);
            }
            if (cardAlbumName) {
                cardAlbumName.textContent = song.album || 'æœªçŸ¥ä¸“è¾‘';
            }
            if (songSection) songSection.style.display = 'flex';
        }

        // æ˜¾ç¤ºè·å–è¯„è®ºçš„ç•Œé¢
        function showGetCommentsInterface(song) {
            console.log('æ˜¾ç¤ºè·å–è¯„è®ºç•Œé¢ï¼Œæ­Œæ›²:', song);

            const resultsContainer = document.getElementById('songResults');
            if (!resultsContainer) {
                console.error('æ‰¾ä¸åˆ° songResults å®¹å™¨');
                return;
            }

            console.log('è®¾ç½®è¯„è®ºç•Œé¢HTML');
            const htmlContent = `
                <div style="padding: 20px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 16px;">
                        <img src="${song.cover || song.fallbackCover}"
                             style="width: 50px; height: 50px; border-radius: 8px;"
                             onerror="this.src='${song.fallbackCover}'">
                        <div style="text-align: left;">
                            <div style="font-size: 16px; font-weight: 500; color: #495057;">${song.name}</div>
                            <div style="font-size: 14px; color: #6c757d;">${song.artist}</div>
                            <div style="font-size: 12px; color: #adb5bd;">${song.album}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">âœ… æ­Œæ›²å·²é€‰æ‹©</div>
                        <div style="font-size: 12px; color: #6c757d;">ç°åœ¨å¯ä»¥è·å–è¿™é¦–æ­Œçš„çƒ­é—¨è¯„è®º</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">é€‰æ‹©è¯„è®ºæ¨¡å¼ï¼š</div>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="loadHotCommentsForSelectedSong()"
                                    style="padding: 10px 20px; font-size: 14px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ”¥ é€‰æ‹©çƒ­é—¨è¯„è®º
                            </button>
                            <button onclick="loadAllCommentsForSelectedSong()"
                                    style="padding: 10px 20px; font-size: 14px; background: #868e96; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ’¬ é€‰æ‹©æ‰€æœ‰è¯„è®º
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">æˆ–è€…ï¼š</div>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="showCustomCommentMode()"
                                    style="padding: 10px 20px; font-size: 14px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                âœï¸ è‡ªå®šä¹‰è¯„è®º
                            </button>
                            <button onclick="displaySearchResults(window.currentSearchResults)"
                                    style="padding: 10px 20px; font-size: 14px; background: #adb5bd; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                é‡æ–°é€‰æ‹©æ­Œæ›²
                            </button>
                        </div>
                    </div>
                </div>
            `;

            console.log('HTMLå†…å®¹é•¿åº¦:', htmlContent.length);
            console.log('HTMLå†…å®¹é¢„è§ˆ:', htmlContent.substring(0, 200) + '...');

            resultsContainer.innerHTML = htmlContent;
            resultsContainer.style.display = 'block';

            console.log('è¯„è®ºç•Œé¢HTMLå·²è®¾ç½®ï¼Œå®¹å™¨æ˜¾ç¤ºçŠ¶æ€:', resultsContainer.style.display);
            console.log('å®¹å™¨å†…å®¹:', resultsContainer.innerHTML.substring(0, 200) + '...');
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰è¯„è®ºæ¨¡å¼
        function showCustomCommentMode() {
            if (!selectedSongData) return;

            const resultsContainer = document.getElementById('songResults');
            resultsContainer.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
                        <img src="${selectedSongData.cover || selectedSongData.fallbackCover}"
                             style="width: 50px; height: 50px; border-radius: 8px;"
                             onerror="this.src='${selectedSongData.fallbackCover}'">
                        <div style="text-align: left;">
                            <div style="font-size: 16px; font-weight: 500; color: #495057;">${selectedSongData.name}</div>
                            <div style="font-size: 14px; color: #6c757d;">${selectedSongData.artist}</div>
                            <div style="font-size: 12px; color: #adb5bd;">${selectedSongData.album}</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 16px; color: #495057; margin-bottom: 8px;">âœï¸ è‡ªå®šä¹‰è¯„è®ºæ¨¡å¼</div>
                        <div style="font-size: 12px; color: #6c757d;">ç›´æ¥å¡«å†™è¡¨å•ï¼Œåˆ›å»ºä½ è‡ªå·±çš„è¯„è®º</div>
                    </div>

                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 14px; color: #495057; margin-bottom: 12px;">å¿«é€Ÿå¡«å……ç¤ºä¾‹ï¼š</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                            <button onclick="fillCustomComment('è¿™é¦–æ­ŒçœŸçš„å¤ªå¥½å¬äº†ï¼æ¯æ¬¡å¬éƒ½æœ‰ä¸åŒçš„æ„Ÿå— ğŸµ', '${selectedSongData.name}', '${selectedSongData.artist}')"
                                    style="padding: 6px 12px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                èµç¾è¯„è®º
                            </button>
                            <button onclick="fillCustomComment('å•æ›²å¾ªç¯ä¸­ï¼Œè¿™æ—‹å¾‹å¤ªä¸Šå¤´äº†ï¼', '${selectedSongData.name}', '${selectedSongData.artist}')"
                                    style="padding: 6px 12px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                å¾ªç¯è¯„è®º
                            </button>
                            <button onclick="fillCustomComment('å¬è¿™é¦–æ­Œæƒ³èµ·äº†å¾ˆå¤šå›å¿†...', '${selectedSongData.name}', '${selectedSongData.artist}')"
                                    style="padding: 6px 12px; font-size: 12px; background: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                å›å¿†è¯„è®º
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="fillCustomComment('', '${selectedSongData.name}', '${selectedSongData.artist}')"
                                style="padding: 10px 20px; font-size: 14px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ğŸ“ å¼€å§‹è‡ªå®šä¹‰
                        </button>
                        <button onclick="showGetCommentsInterface(selectedSongData)"
                                style="padding: 10px 20px; font-size: 14px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            è¿”å›é€‰æ‹©æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;
            resultsContainer.style.display = 'block';
        }

        // å¡«å……è‡ªå®šä¹‰è¯„è®ºåˆ°è¡¨å•
        function fillCustomComment(content, songName, artist) {
            // å¡«å……æ­Œæ›²ä¿¡æ¯
            document.getElementById('songName').value = songName;
            document.getElementById('artistName').value = artist;

            // å¡«å……è¯„è®ºå†…å®¹
            document.getElementById('content').value = content;

            // è®¾ç½®ä¸€ä¸ªåˆç†çš„ç‚¹èµæ•°
            const randomLikes = Math.floor(Math.random() * 10000) + 100;
            document.getElementById('likes').value = randomLikes;

            // æ›´æ–°é¢„è§ˆ
            updatePreview();

            // éšè—æœç´¢ç»“æœ
            document.getElementById('songResults').style.display = 'none';
            document.getElementById('songSearch').value = '';

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            if (content) {
                alert('âœ… å·²å¡«å……ç¤ºä¾‹è¯„è®ºï¼ä½ å¯ä»¥åœ¨è¡¨å•ä¸­ç»§ç»­ç¼–è¾‘ã€‚');
            } else {
                alert('âœ… æ­Œæ›²ä¿¡æ¯å·²å¡«å……ï¼è¯·åœ¨è¡¨å•ä¸­è¾“å…¥ä½ çš„è¯„è®ºå†…å®¹ã€‚');
            }
        }

        // ä¸ºé€‰ä¸­çš„æ­Œæ›²åŠ è½½æ‰€æœ‰è¯„è®º
        async function loadAllCommentsForSelectedSong() {
            if (!selectedSongData) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsContainer = document.getElementById('songResults');
            resultsContainer.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px;">ğŸ’¬ æ­£åœ¨è·å–æ‰€æœ‰è¯„è®º...</div>
                    <div style="font-size: 12px; color: #adb5bd;">è¯·ç¨å€™ï¼Œæ­£åœ¨è·å–éŸ³ä¹æ•°æ®</div>
                </div>
            `;

            try {
                const comments = await getSongComments(selectedSongData.id, 50);

                if (comments.length > 0) {
                    displaySongComments(selectedSongData, comments, 'all');
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px;">ğŸ˜” è¯¥æ­Œæ›²æš‚æ— è¯„è®º</div>
                            <div style="font-size: 12px; color: #adb5bd; margin-bottom: 16px;">å¯èƒ½æ˜¯æ–°æ­Œæˆ–è¯„è®ºè¾ƒå°‘</div>
                            <button onclick="showGetCommentsInterface(selectedSongData)"
                                    style="padding: 8px 16px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                è¿”å›
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                showCommentError('all');
            }
        }

        // ä¸ºé€‰ä¸­çš„æ­Œæ›²åŠ è½½çƒ­é—¨è¯„è®º
        async function loadHotCommentsForSelectedSong() {
            if (!selectedSongData) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultsContainer = document.getElementById('songResults');
            resultsContainer.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px;">ğŸ”¥ æ­£åœ¨è·å–çƒ­é—¨è¯„è®º...</div>
                    <div style="font-size: 12px; color: #adb5bd;">è¯·ç¨å€™ï¼Œæ­£åœ¨è·å–éŸ³ä¹æ•°æ®</div>
                </div>
            `;

            try {
                const comments = await getHotComments(selectedSongData.id, 30);
                console.log('loadHotCommentsForSelectedSong è·å–åˆ°è¯„è®ºæ•°é‡:', comments.length);

                if (comments.length > 0) {
                    console.log('å‡†å¤‡è°ƒç”¨ displaySongCommentsï¼Œæ­Œæ›²:', selectedSongData.name, 'è¯„è®ºæ•°é‡:', comments.length);
                    displaySongComments(selectedSongData, comments, 'hot');
                    console.log('displaySongComments è°ƒç”¨å®Œæˆ');
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px;">ğŸ˜” è¯¥æ­Œæ›²æš‚æ— çƒ­é—¨è¯„è®º</div>
                            <div style="font-size: 12px; color: #adb5bd; margin-bottom: 16px;">å¯èƒ½æ˜¯æ–°æ­Œæˆ–è¯„è®ºè¾ƒå°‘</div>
                            <button onclick="showGetCommentsInterface(selectedSongData)"
                                    style="padding: 8px 16px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                è¿”å›
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è·å–çƒ­é—¨è¯„è®ºå¤±è´¥:', error);
                showCommentError('hot');
            }
        }

        // æ˜¾ç¤ºè¯„è®ºè·å–é”™è¯¯
        function showCommentError(type) {
            const resultsContainer = document.getElementById('songResults');
            const typeText = type === 'hot' ? 'çƒ­é—¨è¯„è®º' : 'è¯„è®º';
            const retryFunction = type === 'hot' ? 'loadHotCommentsForSelectedSong()' : 'loadAllCommentsForSelectedSong()';

            resultsContainer.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 16px; color: #6c757d; margin-bottom: 12px;">ğŸ˜” è·å–${typeText}å¤±è´¥</div>
                    <div style="font-size: 12px; color: #adb5bd; margin-bottom: 16px;">ç½‘ç»œè¿æ¥é—®é¢˜æˆ–APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨</div>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="${retryFunction}"
                                style="padding: 8px 16px; font-size: 12px; background: #868e96; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é‡è¯•
                        </button>
                        <button onclick="showGetCommentsInterface(selectedSongData)"
                                style="padding: 8px 16px; font-size: 12px; background: #adb5bd; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            è¿”å›
                        </button>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ­Œæ›²è¯„è®ºï¼ˆåŒ…æ‹¬çƒ­é—¨è¯„è®ºå’Œæ™®é€šè¯„è®ºï¼‰
        function displaySongComments(song, comments, type = 'all') {
            console.log('displaySongComments è¢«è°ƒç”¨ï¼Œå‚æ•°:', {
                song: song.name,
                commentsLength: comments.length,
                type: type
            });

            const resultsContainer = document.getElementById('songResults');
            console.log('resultsContainer å…ƒç´ :', resultsContainer);

            // ç¡®ä¿å®¹å™¨å¯è§
            resultsContainer.style.display = 'block';

            // åˆ†ç¦»çƒ­é—¨è¯„è®ºå’Œæ™®é€šè¯„è®º
            const hotComments = comments.filter(c => c.isHot);
            const normalComments = comments.filter(c => !c.isHot);

            // æ ¹æ®ç±»å‹è®¾ç½®æ ‡é¢˜
            let titleText = '';
            let buttonSection = '';

            if (type === 'hot') {
                titleText = `ğŸ”¥ ${comments.length} æ¡çƒ­é—¨è¯„è®º (æŒ‰ç‚¹èµæ•°æ’åº)`;
                buttonSection = `
                    <button onclick="loadMoreHotComments()"
                            style="padding: 8px 16px; font-size: 12px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        åŠ è½½æ›´å¤šçƒ­è¯„
                    </button>
                `;
            } else {
                titleText = `ğŸ”¥ ${hotComments.length} æ¡çƒ­é—¨è¯„è®º | ğŸ’¬ ${normalComments.length} æ¡æ™®é€šè¯„è®º (æŒ‰ç‚¹èµæ•°æ’åº)`;
                buttonSection = `
                    <button onclick="loadMoreComments()"
                            style="padding: 8px 16px; font-size: 12px; background: #868e96; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        åŠ è½½æ›´å¤šè¯„è®º
                    </button>
                `;
            }

            resultsContainer.innerHTML = `
                <div style="padding: 16px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <img src="${song.cover || song.fallbackCover}"
                             style="width: 40px; height: 40px; border-radius: 6px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 500; color: #495057;">${song.name}</div>
                            <div style="font-size: 14px; color: #6c757d;">${song.artist}</div>
                            <div style="font-size: 12px; color: #adb5bd;">${song.album}</div>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">
                        ${titleText}
                    </div>
                </div>
                ${comments.slice(0, 20).map((comment, index) => `
                    <div class="comment-item" id="comment-${index}" data-index="${index}" style="
                        padding: 16px;
                        border-bottom: 1px solid #f1f3f4;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                        ${comment.isHot ? 'background: linear-gradient(90deg, rgba(255, 107, 107, 0.05), transparent);' : ''}
                    " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='translateX(4px)'"
                       onmouseout="this.style.backgroundColor='${comment.isHot ? 'rgba(255, 107, 107, 0.05)' : 'transparent'}'; this.style.transform='translateX(0)'">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <img src="${getProxiedImageUrl(comment.avatar)}"
                                 style="width: 32px; height: 32px; border-radius: 50%; background: #e9ecef; flex-shrink: 0;"
                                 onerror="this.style.display='none'">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 13px; font-weight: 500; color: #495057;">${comment.username}</span>
                                    ${comment.isHot ? '<span style="background: #ff6b6b; color: white; font-size: 10px; padding: 1px 4px; border-radius: 2px;">çƒ­è¯„</span>' : ''}
                                    <span style="font-size: 11px; color: #adb5bd;">${comment.timeStr}</span>
                                    <span style="font-size: 12px; color: #ff6b6b; font-weight: 500; margin-left: auto;">
                                        â¤ï¸ ${comment.likedCount.toLocaleString()}
                                    </span>
                                </div>
                                <div style="font-size: 15px; color: #495057; line-height: 1.5; word-wrap: break-word;">
                                    ${comment.content}
                                </div>
                            </div>
                        </div>
                        <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #adb5bd;">
                            ç‚¹å‡»é€‰æ‹©
                        </div>
                    </div>
                `).join('')}
                <div style="padding: 16px; text-align: center; background: #f8f9fa;">
                    <div style="margin-bottom: 12px; font-size: 12px; color: #6c757d;">
                        æ˜¾ç¤ºå‰20æ¡è¯„è®ºï¼Œ${type === 'hot' ? 'ä»…æ˜¾ç¤ºçƒ­é—¨è¯„è®º' : 'çƒ­é—¨è¯„è®ºä¼˜å…ˆæ˜¾ç¤º'}
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        ${buttonSection}
                        <button onclick="showGetCommentsInterface(selectedSongData)"
                                style="padding: 8px 16px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é‡æ–°è·å–è¯„è®º
                        </button>
                        <button onclick="displaySearchResults(window.currentSearchResults)"
                                style="padding: 8px 16px; font-size: 12px; background: #adb5bd; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é‡æ–°é€‰æ‹©æ­Œæ›²
                        </button>
                    </div>
                </div>
            `;

            // å­˜å‚¨å½“å‰è¯„è®ºæ•°æ®
            window.currentComments = comments;
            window.currentSongForComments = song;
            window.currentCommentsOffset = 0;
            window.currentCommentsType = type; // å­˜å‚¨å½“å‰è¯„è®ºç±»å‹

            // ç»‘å®šè¯„è®ºç‚¹å‡»äº‹ä»¶
            setTimeout(() => {
                const commentItems = document.querySelectorAll('.comment-item');
                commentItems.forEach((item, index) => {
                    item.addEventListener('click', function() {
                        const commentIndex = parseInt(this.getAttribute('data-index'));
                        selectComment(commentIndex);
                    });
                });
            }, 100);
        }

        // æ›´æ–°æµ·æŠ¥èƒŒæ™¯
        function updatePosterBackground(coverUrl) {
            console.log('updatePosterBackgroundè¢«è°ƒç”¨ï¼ŒcoverUrl:', coverUrl); // è°ƒè¯•ä¿¡æ¯

            const backgroundCover = document.getElementById('backgroundCover');
            const fallbackBackground = document.getElementById('fallbackBackground');
            const glassOverlay = document.getElementById('glassOverlay');

            console.log('backgroundCoverå…ƒç´ :', backgroundCover); // è°ƒè¯•ä¿¡æ¯

            if (!backgroundCover || !coverUrl) {
                console.log('backgroundCoveræˆ–coverUrlä¸å­˜åœ¨ï¼Œè¿”å›'); // è°ƒè¯•ä¿¡æ¯
                return;
            }

            // å…ˆæµ‹è¯•å›¾ç‰‡æ˜¯å¦èƒ½åŠ è½½
            const testImg = new Image();
            testImg.onload = function() {
                console.log('å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œè®¾ç½®èƒŒæ™¯'); // è°ƒè¯•ä¿¡æ¯

                // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                backgroundCover.style.backgroundImage = `url('${coverUrl}')`;

                // æ˜¾ç¤ºèƒŒæ™¯å°é¢ï¼Œéšè—å¤‡ç”¨èƒŒæ™¯
                backgroundCover.style.opacity = '0.9';
                if (fallbackBackground) {
                    fallbackBackground.style.opacity = '0.1';
                }

                // å¢å¼ºç£¨ç»ç’ƒæ•ˆæœ
                backgroundCover.style.filter = 'blur(12px) brightness(0.6) saturate(1.4) contrast(1.2)';
                backgroundCover.style.transform = 'scale(1.2)';

                // è°ƒæ•´æ¯›ç»ç’ƒé®ç½©å±‚ï¼Œè®©èƒŒæ™¯æ›´çªå‡º
                if (glassOverlay) {
                    glassOverlay.style.background = `linear-gradient(135deg,
                        rgba(255, 255, 255, 0.65) 0%,
                        rgba(248, 250, 252, 0.6) 20%,
                        rgba(240, 245, 251, 0.55) 50%,
                        rgba(235, 240, 248, 0.6) 80%,
                        rgba(255, 255, 255, 0.7) 100%)`;
                    glassOverlay.style.backdropFilter = 'blur(35px) saturate(1.8) brightness(1.25) contrast(1.2)';
                }

                console.log('èƒŒæ™¯æ ·å¼è®¾ç½®å®Œæˆ'); // è°ƒè¯•ä¿¡æ¯
            };

            testImg.onerror = function() {
                console.log('å›¾ç‰‡åŠ è½½å¤±è´¥:', coverUrl); // è°ƒè¯•ä¿¡æ¯
                // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä»£ç†
                const proxiedUrl = getProxiedImageUrl(coverUrl);
                console.log('å°è¯•ä½¿ç”¨ä»£ç†URL:', proxiedUrl); // è°ƒè¯•ä¿¡æ¯

                backgroundCover.style.backgroundImage = `url('${proxiedUrl}')`;
                backgroundCover.style.opacity = '0.9';
                if (fallbackBackground) {
                    fallbackBackground.style.opacity = '0.1';
                }
                backgroundCover.style.filter = 'blur(12px) brightness(0.6) saturate(1.4) contrast(1.2)';
                backgroundCover.style.transform = 'scale(1.2)';
            };

            testImg.src = coverUrl;
        }

        // æµ‹è¯•èƒŒæ™¯å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°ä¸­è°ƒç”¨
        function testBackground() {
            const backgroundCover = document.getElementById('backgroundCover');
            const fallbackBackground = document.getElementById('fallbackBackground');

            console.log('backgroundCover:', backgroundCover);
            console.log('fallbackBackground:', fallbackBackground);

            if (backgroundCover) {
                // ä½¿ç”¨ä¸€ä¸ªæµ‹è¯•å›¾ç‰‡
                backgroundCover.style.backgroundImage = "url('https://p1.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg')";
                backgroundCover.style.opacity = '0.9';
                backgroundCover.style.filter = 'blur(12px) brightness(0.6) saturate(1.4) contrast(1.2)';
                backgroundCover.style.transform = 'scale(1.2)';
                console.log('æµ‹è¯•èƒŒæ™¯è®¾ç½®å®Œæˆ');
            }

            if (fallbackBackground) {
                fallbackBackground.style.opacity = '0.1';
            }
        }

        // æµ‹è¯•å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°ä¸­è°ƒç”¨
        function testUpdateElements() {
            const usernameEl = document.getElementById('usernameDisplay');
            const contentEl = document.getElementById('contentDisplay');
            const likesEl = document.getElementById('likesDisplay');
            const dateEl = document.getElementById('dateDisplay');

            console.log('usernameEl:', usernameEl);
            console.log('contentEl:', contentEl);
            console.log('likesEl:', likesEl);
            console.log('dateEl:', dateEl);

            if (usernameEl) {
                usernameEl.textContent = 'æµ‹è¯•ç”¨æˆ·å';
                usernameEl.style.color = 'red';
            }
            if (contentEl) {
                contentEl.innerHTML = 'æµ‹è¯•è¯„è®ºå†…å®¹';
                contentEl.style.color = 'blue';
                contentEl.style.webkitTextFillColor = 'blue';
                contentEl.style.background = 'none';
            }
            if (likesEl) {
                likesEl.textContent = '9999';
                likesEl.style.color = 'green';
            }
            if (dateEl) {
                dateEl.textContent = 'æµ‹è¯•æ—¥æœŸ';
                dateEl.style.color = 'purple';
            }

            console.log('æµ‹è¯•æ›´æ–°å®Œæˆ');
        }

        // é€‰æ‹©è¯„è®º
        function selectComment(index) {
            if (!window.currentComments || !window.currentComments[index] || !window.currentSongForComments) return;

            const comment = window.currentComments[index];
            const song = window.currentSongForComments;

            // è®¾ç½®æ­Œæ›²ä¿¡æ¯
            selectedSongData = song;

            // æ›´æ–°é€‰ä¸­æ­Œæ›²æ˜¾ç¤º
            const selectedCover = document.getElementById('selectedSongCover');
            if (selectedCover) {
                selectedCover.src = song.cover || song.fallbackCover;
                selectedCover.onerror = () => { selectedCover.src = song.fallbackCover; };
            }

            const selectedSongName = document.getElementById('selectedSongName');
            const selectedSongArtist = document.getElementById('selectedSongArtist');
            const selectedSongDiv = document.getElementById('selectedSong');

            if (selectedSongName) selectedSongName.textContent = song.name;
            if (selectedSongArtist) selectedSongArtist.textContent = song.artist;
            if (selectedSongDiv) selectedSongDiv.style.display = 'block';

            // æ›´æ–°è¯„è®ºå¡ç‰‡ä¸­çš„æ­Œæ›²ä¿¡æ¯
            const cardCover = document.getElementById('cardSongCover');
            cardCover.src = song.cover || song.fallbackCover;
            cardCover.onerror = () => { cardCover.src = song.fallbackCover; };

            document.getElementById('cardSongName').textContent = song.name;
            document.getElementById('cardSongArtist').textContent = song.artist;
            document.getElementById('cardAlbumName').textContent = song.album || 'æœªçŸ¥ä¸“è¾‘';
            document.getElementById('songSection').style.display = 'flex';

            // æ›´æ–°è¡¨å•ä¸­çš„è¯„è®ºä¿¡æ¯
            document.getElementById('username').value = comment.username;
            document.getElementById('content').value = comment.content;
            document.getElementById('likes').value = comment.likedCount;
            document.getElementById('date').value = comment.timeStr;

            // éšæœºè®¾ç½®VIPçŠ¶æ€ï¼ˆå› ä¸ºAPIå¯èƒ½ä¸è¿”å›VIPä¿¡æ¯ï¼‰
            document.getElementById('isVip').checked = Math.random() > 0.7;

            // è®¾ç½®çƒ­è¯„æ ‡ç­¾ï¼ˆå› ä¸ºè¿™äº›éƒ½æ˜¯çƒ­é—¨è¯„è®ºï¼‰
            document.getElementById('hotTag').value = 'çƒ­è¯„';

            // è®¾ç½®å…¨å±€å˜é‡ï¼Œä¾›é¢„è§ˆä½¿ç”¨
            selectedComment = {
                username: comment.username,
                content: comment.content,
                likes: comment.likedCount,
                date: comment.timeStr,
                isVip: Math.random() > 0.7, // éšæœºVIPçŠ¶æ€
                isHot: true, // è¿™äº›éƒ½æ˜¯çƒ­é—¨è¯„è®º
                vipLevel: 'VIPÂ·é™†',
                avatar: getProxiedImageUrl(comment.avatar) // æ·»åŠ å¤´åƒURL
            };

            selectedSong = {
                name: song.name,
                artist: song.artist,
                album: song.album,
                cover: song.cover || song.fallbackCover
            };

            // æ›´æ–°é¢„è§ˆå¡ç‰‡å†…å®¹
            updatePreview();

            // æ›´æ–°èƒŒæ™¯å°é¢
            updatePosterBackground(song.cover || song.fallbackCover);

            // è®¾ç½®å±…ä¸­èƒŒæ™¯å›¾ç‰‡å’Œæ¯›ç»ç’ƒæ•ˆæœ
            setTimeout(() => {
                const backgroundCover = document.getElementById('backgroundCover');
                if (backgroundCover) {
                    // æ¸…é™¤ä¹‹å‰çš„èƒŒæ™¯è®¾ç½®
                    backgroundCover.style.backgroundImage = 'none';
                    backgroundCover.style.backgroundColor = 'transparent';
                    backgroundCover.style.filter = 'none';

                    // åˆ›å»ºèƒŒæ™¯å›¾ç‰‡å®¹å™¨
                    let backgroundImageContainer = document.getElementById('backgroundImageContainer');
                    if (!backgroundImageContainer) {
                        backgroundImageContainer = document.createElement('div');
                        backgroundImageContainer.id = 'backgroundImageContainer';
                        backgroundCover.appendChild(backgroundImageContainer);
                    }

                    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡å®¹å™¨æ ·å¼ - å±…ä¸­æ­£æ–¹å½¢ï¼Œå››å‘¨ç•™è¾¹è·
                    backgroundImageContainer.style.position = 'absolute';
                    backgroundImageContainer.style.top = '50%';
                    backgroundImageContainer.style.left = '50%';
                    backgroundImageContainer.style.transform = 'translate(-50%, -50%)';
                    backgroundImageContainer.style.width = '60%';  // å å±å¹•å®½åº¦çš„60%
                    backgroundImageContainer.style.height = '60%'; // å å±å¹•é«˜åº¦çš„60%
                    backgroundImageContainer.style.maxWidth = '500px';  // æœ€å¤§å®½åº¦
                    backgroundImageContainer.style.maxHeight = '500px'; // æœ€å¤§é«˜åº¦
                    backgroundImageContainer.style.backgroundImage = `url('${song.cover || song.fallbackCover}')`;
                    backgroundImageContainer.style.backgroundSize = 'cover';
                    backgroundImageContainer.style.backgroundPosition = 'center';
                    backgroundImageContainer.style.backgroundRepeat = 'no-repeat';
                    backgroundImageContainer.style.borderRadius = '20px';
                    backgroundImageContainer.style.zIndex = '2';

                    // åˆ›å»ºä¸­å¿ƒæ¸…æ™°å›¾ç‰‡
                    let centerImage = document.getElementById('centerImage');
                    if (!centerImage) {
                        centerImage = document.createElement('div');
                        centerImage.id = 'centerImage';
                        backgroundCover.appendChild(centerImage);
                    }

                    // è®¾ç½®ä¸­å¿ƒæ¸…æ™°å›¾ç‰‡æ ·å¼
                    centerImage.style.position = 'absolute';
                    centerImage.style.top = '50%';
                    centerImage.style.left = '50%';
                    centerImage.style.transform = 'translate(-50%, -50%)';
                    centerImage.style.width = '300px';
                    centerImage.style.height = '300px';
                    centerImage.style.backgroundImage = `url('${song.cover || song.fallbackCover}')`;
                    centerImage.style.backgroundSize = 'cover';
                    centerImage.style.backgroundPosition = 'center';
                    centerImage.style.backgroundRepeat = 'no-repeat';
                    centerImage.style.borderRadius = '15px';
                    centerImage.style.boxShadow = '0 15px 30px rgba(0,0,0,0.4)';
                    centerImage.style.zIndex = '10';

                    // éšè—å¤‡ç”¨èƒŒæ™¯
                    const fallbackBackground = document.getElementById('fallbackBackground');
                    if (fallbackBackground) {
                        fallbackBackground.style.opacity = '0';
                    }

                    // è®¾ç½®æ¯›ç»ç’ƒé®ç½©å±‚è¦†ç›–æ•´ä¸ªèƒŒæ™¯
                    const glassOverlay = document.getElementById('glassOverlay');
                    if (glassOverlay) {
                        glassOverlay.style.background = `linear-gradient(135deg,
                            rgba(255, 255, 255, 0.3) 0%,
                            rgba(248, 250, 252, 0.2) 30%,
                            rgba(240, 245, 251, 0.15) 50%,
                            rgba(235, 240, 248, 0.2) 70%,
                            rgba(255, 255, 255, 0.35) 100%)`;
                        glassOverlay.style.backdropFilter = 'blur(25px) saturate(1.3) brightness(1.1)';
                        glassOverlay.style.opacity = '0.8';
                        glassOverlay.style.zIndex = '5';
                    }

                    console.log('å±…ä¸­èƒŒæ™¯å›¾ç‰‡å’Œæ¯›ç»ç’ƒæ•ˆæœè®¾ç½®å®Œæˆ');
                }
            }, 200);

            // æ›´æ–°é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ
            updateCommentSelection(index);

            // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆä¸éšè—è¯„è®ºåˆ—è¡¨ï¼Œæ–¹ä¾¿åˆ‡æ¢ï¼‰
            // ä½¿ç”¨æ›´ç®€æ´çš„æç¤ºï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: opacity 0.3s ease;
            `;
            toast.textContent = 'âœ… å·²é€‰æ‹©è¯¥è¯„è®º';
            document.body.appendChild(toast);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        // æ›´æ–°è¯„è®ºé€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ
        function updateCommentSelection(selectedIndex) {
            // ç§»é™¤æ‰€æœ‰è¯„è®ºçš„é€‰ä¸­çŠ¶æ€
            const allComments = document.querySelectorAll('.comment-item');
            allComments.forEach((item, index) => {
                const isHot = window.currentComments && window.currentComments[index] && window.currentComments[index].isHot;
                if (index === selectedIndex) {
                    // é€‰ä¸­çŠ¶æ€ï¼šæ·»åŠ è“è‰²è¾¹æ¡†å’ŒèƒŒæ™¯
                    item.style.background = 'linear-gradient(90deg, rgba(0, 123, 255, 0.1), transparent)';
                    item.style.borderLeft = '4px solid #007bff';
                    item.style.boxShadow = '0 2px 8px rgba(0, 123, 255, 0.15)';
                } else {
                    // æœªé€‰ä¸­çŠ¶æ€ï¼šæ¢å¤åŸå§‹æ ·å¼
                    item.style.background = isHot ? 'linear-gradient(90deg, rgba(255, 107, 107, 0.05), transparent)' : 'transparent';
                    item.style.borderLeft = 'none';
                    item.style.boxShadow = 'none';
                }
            });
        }

        // åŠ è½½æ›´å¤šè¯„è®º
        async function loadMoreComments() {
            if (!selectedSongData) return;

            const currentOffset = window.currentCommentsOffset || 0;
            const newOffset = currentOffset + 50;

            try {
                const moreComments = await getSongComments(selectedSongData.id, 50, newOffset);

                if (moreComments.length > 0) {
                    // åˆå¹¶æ–°è¯„è®ºåˆ°ç°æœ‰è¯„è®ºä¸­
                    const existingComments = window.currentComments || [];
                    const allComments = [...existingComments, ...moreComments];

                    // å»é‡ï¼ˆåŸºäºç”¨æˆ·IDå’Œæ—¶é—´ï¼‰
                    const uniqueComments = allComments.filter((comment, index, self) =>
                        index === self.findIndex(c => c.userId === comment.userId && c.time === comment.time)
                    );

                    // é‡æ–°æ’åº
                    uniqueComments.sort((a, b) => {
                        if (a.isHot && !b.isHot) return -1;
                        if (!a.isHot && b.isHot) return 1;
                        return b.likedCount - a.likedCount;
                    });

                    window.currentComments = uniqueComments;
                    window.currentCommentsOffset = newOffset;

                    displaySongComments(selectedSongData, uniqueComments);
                } else {
                    alert('æ²¡æœ‰æ›´å¤šè¯„è®ºäº†');
                }
            } catch (error) {
                console.error('åŠ è½½æ›´å¤šè¯„è®ºå¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½æ›´å¤šçƒ­é—¨è¯„è®º
        async function loadMoreHotComments() {
            if (!selectedSongData) return;

            const currentOffset = window.currentCommentsOffset || 0;
            const newOffset = currentOffset + 30;

            try {
                const moreComments = await getHotComments(selectedSongData.id, 30, newOffset);

                if (moreComments.length > 0) {
                    // åˆå¹¶æ–°è¯„è®ºåˆ°ç°æœ‰è¯„è®ºä¸­
                    const existingComments = window.currentComments || [];
                    const allComments = [...existingComments, ...moreComments];

                    // å»é‡ï¼ˆåŸºäºç”¨æˆ·IDå’Œæ—¶é—´ï¼‰
                    const uniqueComments = allComments.filter((comment, index, self) =>
                        index === self.findIndex(c => c.userId === comment.userId && c.time === comment.time)
                    );

                    // é‡æ–°æ’åº
                    uniqueComments.sort((a, b) => b.likedCount - a.likedCount);

                    window.currentComments = uniqueComments;
                    window.currentCommentsOffset = newOffset;

                    displaySongComments(selectedSongData, uniqueComments, 'hot');
                } else {
                    alert('æ²¡æœ‰æ›´å¤šçƒ­é—¨è¯„è®ºäº†');
                }
            } catch (error) {
                console.error('åŠ è½½æ›´å¤šçƒ­é—¨è¯„è®ºå¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…¼å®¹æ—§çš„selectSongå‡½æ•°ï¼ˆç”¨äºæ¨¡æ¿åŠ è½½ï¼‰
        function selectSong(songId) {
            // å¦‚æœæ˜¯ä»æ¨¡æ¿åŠ è½½ï¼Œå…ˆæœç´¢è¯¥æ­Œæ›²
            if (typeof songId === 'object') {
                // ç›´æ¥ä¼ å…¥æ­Œæ›²å¯¹è±¡
                selectedSongData = songId;
                updateSelectedSongDisplay(songId);
            } else {
                // é€šè¿‡IDæŸ¥æ‰¾ï¼ˆæš‚æ—¶ä¸æ”¯æŒï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨ä½¿ç”¨çœŸå®APIï¼‰
                console.warn('é€šè¿‡IDé€‰æ‹©æ­Œæ›²æš‚ä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨æœç´¢åŠŸèƒ½');
            }
        }

        // æ›´æ–°é€‰ä¸­æ­Œæ›²æ˜¾ç¤ºçš„è¾…åŠ©å‡½æ•°
        function updateSelectedSongDisplay(song) {
            const selectedCover = document.getElementById('selectedSongCover');
            selectedCover.src = song.cover || song.fallbackCover;
            selectedCover.onerror = () => { selectedCover.src = song.fallbackCover; };

            document.getElementById('selectedSongName').textContent = song.name;
            document.getElementById('selectedSongArtist').textContent = song.artist;
            document.getElementById('selectedSong').style.display = 'block';

            const cardCover = document.getElementById('cardSongCover');
            cardCover.src = song.cover || song.fallbackCover;
            cardCover.onerror = () => { cardCover.src = song.fallbackCover; };

            document.getElementById('cardSongName').textContent = song.name;
            document.getElementById('cardSongArtist').textContent = song.artist;
            document.getElementById('songSection').style.display = 'flex';
        }

        // æ¸…é™¤é€‰ä¸­çš„æ­Œæ›²
        function clearSelectedSong() {
            selectedSongData = null;
            document.getElementById('selectedSong').style.display = 'none';
            document.getElementById('songSection').style.display = 'none';
        }

        // æ’­æ”¾æ­Œæ›²é¢„è§ˆï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function playSongPreview() {
            if (!selectedSongData) return;

            const cover = document.getElementById('cardSongCover');
            cover.style.transform = 'scale(0.95)';

            setTimeout(() => {
                cover.style.transform = 'scale(1)';
            }, 150);

            // æ˜¾ç¤ºæ’­æ”¾æç¤º
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeInOut 2s ease-in-out;
            `;
            notification.textContent = `æ­£åœ¨æ’­æ”¾: ${selectedSongData.name} - ${selectedSongData.artist}`;

            // æ·»åŠ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
                document.head.removeChild(style);
            }, 2000);
        }

        // æ¨¡æ¿æ•°æ®
        const templates = {
            template1: {
                username: 'æ·±æµ·é‡Œçš„é±¼',
                isVip: false,
                date: '2024å¹´03æœˆ15æ—¥',
                hotTag: '',
                content: 'å‡Œæ™¨ä¸‰ç‚¹çš„é›¨å£°ï¼Œåƒæäº†æˆ‘å†…å¿ƒçš„ç‹¬ç™½',
                likes: 2847,
                suggestedSearch: 'å‡Œæ™¨ä¸‰ç‚¹'
            },
            template2: {
                username: 'æœˆäº®ä¸ç¡æˆ‘ä¸ç¡',
                isVip: false,
                date: '2024å¹´02æœˆ28æ—¥',
                hotTag: '',
                content: 'åˆæ˜¯ä¸€ä¸ªå¤±çœ çš„å¤œæ™šï¼Œè¿™é¦–æ­Œé™ªæˆ‘åˆ°å¤©äº®',
                likes: 1563,
                suggestedSearch: 'å¤±çœ é£è¡Œ'
            },
            template3: {
                username: 'å­¤ç‹¬æ‚£è€…',
                isVip: false,
                date: '2024å¹´01æœˆ20æ—¥',
                hotTag: '',
                content: 'æœ‰äº›è¯åªèƒ½å¯¹ç€æ­Œè¯è¯´ï¼Œæœ‰äº›çœ¼æ³ªåªèƒ½åœ¨æ·±å¤œæµ',
                likes: 4291,
                suggestedSearch: 'å­¤ç‹¬æ‚£è€…'
            }
        };

        // åŠ è½½æ¨¡æ¿
        function loadTemplate() {
            const templateSelect = document.getElementById('template');
            const selectedTemplate = templateSelect.value;

            if (selectedTemplate && templates[selectedTemplate]) {
                const template = templates[selectedTemplate];
                document.getElementById('username').value = template.username;
                document.getElementById('isVip').checked = template.isVip;
                document.getElementById('date').value = template.date;
                document.getElementById('hotTag').value = template.hotTag;
                document.getElementById('content').value = template.content;
                document.getElementById('likes').value = template.likes;

                // è®¾ç½®å»ºè®®æœç´¢çš„æ­Œæ›²å
                if (template.suggestedSearch) {
                    document.getElementById('songSearch').value = template.suggestedSearch;
                    // å¯ä»¥é€‰æ‹©è‡ªåŠ¨æœç´¢
                    // searchSong();
                } else {
                    clearSelectedSong();
                }

                updatePreview();
            }
        }

        // è·å–å½“å‰æ—¥æœŸ
        function setToday() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}å¹´${month}æœˆ${day}æ—¥`;
            document.getElementById('date').value = dateStr;
            // ä¸åœ¨è¿™é‡Œè°ƒç”¨updatePreviewï¼Œé¿å…è¦†ç›–é€‰ä¸­çš„è¯„è®º
        }



        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            // å¦‚æœæœ‰é€‰ä¸­çš„è¯„è®ºï¼Œä½¿ç”¨é€‰ä¸­è¯„è®ºçš„æ•°æ®ï¼Œå¦åˆ™ä½¿ç”¨è¡¨å•æ•°æ®
            let username, isVip, date, hotTag, content, likes;

            if (selectedComment) {
                username = selectedComment.username;
                isVip = selectedComment.isVip;
                date = selectedComment.date;
                hotTag = selectedComment.isHot ? 'çƒ­' : '';
                content = selectedComment.content;
                likes = selectedComment.likes;
            } else {
                username = document.getElementById('username').value || 'æ·±æµ·é‡Œçš„é±¼';
                isVip = document.getElementById('isVip').checked;
                date = document.getElementById('date').value || '2024å¹´03æœˆ15æ—¥';
                hotTag = document.getElementById('hotTag').value;
                content = document.getElementById('content').value || 'å‡Œæ™¨ä¸‰ç‚¹çš„é›¨å£°ï¼Œåƒæäº†æˆ‘å†…å¿ƒçš„ç‹¬ç™½';
                likes = document.getElementById('likes').value || '2847';
            }

            // æ›´æ–°é¢„è§ˆå¡ç‰‡å†…å®¹
            const usernameDisplay = document.getElementById('usernameDisplay');
            const dateDisplay = document.getElementById('dateDisplay');
            const likesDisplay = document.getElementById('likesDisplay');

            if (usernameDisplay) usernameDisplay.textContent = username;
            if (dateDisplay) dateDisplay.textContent = date;
            if (likesDisplay) likesDisplay.textContent = likes;

            // ç‰¹æ®Šå¤„ç†contentDisplayï¼Œç¡®ä¿æ ·å¼æ­£ç¡®
            const contentDisplay = document.getElementById('contentDisplay');
            if (contentDisplay) {
                contentDisplay.style.webkitTextFillColor = '#2c3e50';
                contentDisplay.style.color = '#2c3e50';
                contentDisplay.style.background = 'none';
                contentDisplay.innerHTML = content;
            }

            // æ›´æ–°VIPæ ‡è¯†
            const vipBadge = document.getElementById('vipBadge');
            if (isVip) {
                vipBadge.style.display = 'inline';
                vipBadge.textContent = selectedComment?.vipLevel || 'VIPÂ·é™†';
            } else {
                vipBadge.style.display = 'none';
            }

            // æ›´æ–°æ ‡ç­¾
            const hotTagDisplay = document.getElementById('hotTagDisplay');
            if (hotTag) {
                hotTagDisplay.textContent = hotTag;
                hotTagDisplay.style.display = 'inline';
            } else {
                hotTagDisplay.style.display = 'none';
            }

            // æ›´æ–°å¤´åƒ
            const avatarDisplay = document.getElementById('avatarDisplay');
            if (selectedComment && selectedComment.avatar) {
                // å¦‚æœæœ‰é€‰ä¸­è¯„è®ºä¸”æœ‰å¤´åƒï¼Œæ˜¾ç¤ºçœŸå®å¤´åƒ
                avatarDisplay.innerHTML = `<img src="${selectedComment.avatar}" style="
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    object-fit: cover;
                " onerror="this.parentNode.innerHTML='${username.charAt(0)}'; this.parentNode.style.background='#ff6b6b'; this.parentNode.style.color='white';">`;
                avatarDisplay.style.background = 'transparent';
                avatarDisplay.style.color = 'transparent';
            } else {
                // å¦åˆ™æ˜¾ç¤ºç”¨æˆ·åé¦–å­—æ¯
                avatarDisplay.textContent = username.charAt(0);
                avatarDisplay.style.background = '#ff6b6b';
                avatarDisplay.style.color = 'white';
            }

            // æ›´æ–°æ­Œæ›²ä¿¡æ¯ï¼ˆå¦‚æœæœ‰é€‰ä¸­çš„æ­Œæ›²ï¼‰
            const songSection = document.getElementById('songSection');
            if (selectedSong) {
                songSection.style.display = 'flex';
                const cardCover = document.getElementById('cardSongCover');
                cardCover.src = selectedSong.cover;
                cardCover.onerror = () => { cardCover.src = selectedSong.cover; };

                const cardSongName = document.getElementById('cardSongName');
                const cardSongArtist = document.getElementById('cardSongArtist');
                const cardAlbumName = document.getElementById('cardAlbumName');

                cardSongName.textContent = selectedSong.name;
                cardSongArtist.textContent = selectedSong.artist;
                if (cardAlbumName) {
                    cardAlbumName.textContent = selectedSong.album || 'æœªçŸ¥ä¸“è¾‘';
                }

                // æ›´æ–°èƒŒæ™¯å°é¢
                updateBackgroundCover(selectedSong.cover);

                // è‡ªåŠ¨è°ƒæ•´å­—ä½“å¤§å°
                setTimeout(() => {
                    autoResizeText(cardSongName, 13);
                    autoResizeText(cardSongArtist, 10);
                }, 50);
            } else {
                songSection.style.display = 'none';
                // æ¸…é™¤èƒŒæ™¯å°é¢ï¼Œæ˜¾ç¤ºå¤‡ç”¨èƒŒæ™¯
                updateBackgroundCover(null);
            }

            // è§¦å‘é—ªå…‰æ•ˆæœ
            triggerShineEffect();
        }

        // è§¦å‘é—ªå…‰æ•ˆæœ
        function triggerShineEffect() {
            const shineEffect = document.getElementById('shineEffect');
            if (shineEffect) {
                shineEffect.style.left = '-100%';
                setTimeout(() => {
                    shineEffect.style.left = '100%';
                }, 100);
            }
        }

        // æ›´æ–°èƒŒæ™¯å°é¢
        function updateBackgroundCover(coverUrl) {
            const backgroundCover = document.getElementById('backgroundCover');
            const fallbackBackground = document.getElementById('fallbackBackground');

            if (!backgroundCover) return;

            if (!coverUrl) {
                // å¦‚æœæ²¡æœ‰å°é¢ï¼Œæ˜¾ç¤ºå¤‡ç”¨èƒŒæ™¯
                backgroundCover.style.opacity = '0';
                if (fallbackBackground) {
                    fallbackBackground.style.opacity = '1';
                    fallbackBackground.style.transform = 'scale(1)';
                }
                return;
            }

            // é¢„åŠ è½½å›¾ç‰‡
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = function() {
                // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ›´æ–°èƒŒæ™¯
                backgroundCover.style.backgroundImage = `url('${coverUrl}')`;

                // æ·»åŠ ç¼©æ”¾æ•ˆæœï¼Œåˆ›é€ æ™¯æ·±æ„Ÿ
                backgroundCover.style.transform = 'scale(1.1)';
                backgroundCover.style.filter = 'blur(1px) brightness(0.9) saturate(1.2)';

                // æ¸æ˜¾èƒŒæ™¯å°é¢
                setTimeout(() => {
                    backgroundCover.style.opacity = '0.9';
                    if (fallbackBackground) {
                        fallbackBackground.style.opacity = '0';
                        fallbackBackground.style.transform = 'scale(1.05)';
                    }
                }, 100);

                console.log('èƒŒæ™¯å°é¢æ›´æ–°æˆåŠŸ:', coverUrl);
            };

            img.onerror = function() {
                // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨èƒŒæ™¯
                backgroundCover.style.opacity = '0';
                if (fallbackBackground) {
                    fallbackBackground.style.opacity = '1';
                    fallbackBackground.style.transform = 'scale(1)';
                }
                console.log('èƒŒæ™¯å°é¢åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨èƒŒæ™¯');
            };

            img.src = coverUrl;
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡å­—å¤§å°ä»¥é€‚åº”å®¹å™¨
        function autoResizeText(element, maxFontSize, minFontSize = 8) {
            if (!element || !element.textContent.trim()) return;

            const container = element.parentElement;
            const containerWidth = container.offsetWidth;
            const containerHeight = parseInt(getComputedStyle(element).height);

            let fontSize = maxFontSize;
            element.style.fontSize = fontSize + 'px';

            // åˆ›å»ºä¸´æ—¶æµ‹é‡å…ƒç´ 
            const tempElement = element.cloneNode(true);
            tempElement.style.position = 'absolute';
            tempElement.style.visibility = 'hidden';
            tempElement.style.height = 'auto';
            tempElement.style.width = containerWidth + 'px';
            tempElement.style.whiteSpace = 'normal';
            tempElement.style.wordWrap = 'break-word';
            document.body.appendChild(tempElement);

            // é€æ­¥å‡å°å­—ä½“ç›´åˆ°é€‚åˆå®¹å™¨
            while (fontSize > minFontSize) {
                tempElement.style.fontSize = fontSize + 'px';

                if (tempElement.offsetHeight <= containerHeight) {
                    break;
                }

                fontSize -= 0.5;
            }

            // åº”ç”¨æœ€ç»ˆå­—ä½“å¤§å°
            element.style.fontSize = fontSize + 'px';

            // æ¸…ç†ä¸´æ—¶å…ƒç´ 
            document.body.removeChild(tempElement);
        }

        // æ‰‹åŠ¨ç»˜åˆ¶æµ·æŠ¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        async function createManualPoster() {
            return new Promise((resolve, reject) => {
                try {
                    const posterContainer = document.getElementById('posterContainer');
                    const rect = posterContainer.getBoundingClientRect();

                    const canvas = document.createElement('canvas');
                    canvas.width = rect.width * 2;
                    canvas.height = rect.height * 2;
                    const ctx = canvas.getContext('2d');

                    // è®¾ç½®é«˜è´¨é‡æ¸²æŸ“
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // ç»˜åˆ¶å¤œé—´æ¨¡å¼ä¸»èƒŒæ™¯æ¸å˜
                    const mainGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    mainGradient.addColorStop(0, '#1a1a2e');   // æ·±è“ç°
                    mainGradient.addColorStop(0.25, '#16213e'); // æ·±è“
                    mainGradient.addColorStop(0.5, '#0f3460');  // ä¸­è“
                    mainGradient.addColorStop(0.75, '#16213e'); // æ·±è“
                    mainGradient.addColorStop(1, '#1a1a2e');   // æ·±è“ç°
                    ctx.fillStyle = mainGradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // ç»˜åˆ¶å®¹å™¨èƒŒæ™¯ï¼ˆæ¨¡æ‹Ÿæ¯›ç»ç’ƒæ•ˆæœï¼‰
                    const containerPadding = 40;
                    const containerX = containerPadding;
                    const containerY = containerPadding;
                    const containerWidth = canvas.width - containerPadding * 2;
                    const containerHeight = canvas.height - containerPadding * 2;
                    const borderRadius = 40;

                    // å®¹å™¨èƒŒæ™¯
                    ctx.save();
                    ctx.beginPath();
                    ctx.roundRect(containerX, containerY, containerWidth, containerHeight, borderRadius);
                    ctx.clip();

                    const containerGradient = ctx.createLinearGradient(containerX, containerY, containerX + containerWidth, containerY + containerHeight);
                    containerGradient.addColorStop(0, 'rgba(40, 50, 70, 0.4)');   // æ·±è‰²åŠé€æ˜
                    containerGradient.addColorStop(0.5, 'rgba(30, 40, 60, 0.3)'); // æ›´æ·±çš„ä¸­é—´
                    containerGradient.addColorStop(1, 'rgba(40, 50, 70, 0.4)');   // æ·±è‰²åŠé€æ˜
                    ctx.fillStyle = containerGradient;
                    ctx.fillRect(containerX, containerY, containerWidth, containerHeight);
                    ctx.restore();

                    // ç»˜åˆ¶å®¹å™¨è¾¹æ¡†ï¼ˆå¤œé—´æ¨¡å¼ï¼Œæ— é˜´å½±ï¼‰
                    ctx.strokeStyle = 'rgba(100, 120, 150, 0.5)'; // æŸ”å’Œçš„è“ç°è‰²è¾¹æ¡†
                    ctx.lineWidth = 2; // æ›´ç»†çš„è¾¹æ¡†
                    ctx.beginPath();
                    ctx.roundRect(containerX, containerY, containerWidth, containerHeight, borderRadius);
                    ctx.stroke();

                    // ç»˜åˆ¶æ­Œæ›²ä¿¡æ¯åŒºåŸŸ
                    const songSectionY = containerY + 40;
                    const songSectionHeight = 120;

                    ctx.save();
                    ctx.beginPath();
                    ctx.roundRect(containerX + 30, songSectionY, containerWidth - 60, songSectionHeight, 20);
                    ctx.clip();

                    const songGradient = ctx.createLinearGradient(0, songSectionY, 0, songSectionY + songSectionHeight);
                    songGradient.addColorStop(0, 'rgba(50,60,80,0.9)');   // æ·±è‰²èƒŒæ™¯
                    songGradient.addColorStop(1, 'rgba(40,50,70,0.9)');   // æ›´æ·±çš„åº•éƒ¨
                    ctx.fillStyle = songGradient;
                    ctx.fillRect(containerX + 30, songSectionY, containerWidth - 60, songSectionHeight);
                    ctx.restore();

                    // æ­Œæ›²ä¿¡æ¯è¾¹æ¡†ï¼ˆå¤œé—´æ¨¡å¼ï¼‰
                    ctx.strokeStyle = 'rgba(100,120,150,0.3)'; // æŸ”å’Œçš„è¾¹æ¡†
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.roundRect(containerX + 30, songSectionY, containerWidth - 60, songSectionHeight, 20);
                    ctx.stroke();

                    // ç»˜åˆ¶æ­Œæ›²æ ‡é¢˜ï¼ˆå¤œé—´æ¨¡å¼æ–‡å­—ï¼‰
                    const songTitle = document.getElementById('songTitle');
                    const songTitleText = songTitle ? songTitle.textContent : 'æ­Œæ›²æ ‡é¢˜';
                    ctx.fillStyle = '#e0e6ed'; // æµ…è‰²æ–‡å­—
                    ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(songTitleText, canvas.width / 2, songSectionY + 45);

                    // ç»˜åˆ¶æ­Œæ‰‹åï¼ˆå¤œé—´æ¨¡å¼ï¼‰
                    const artistName = document.getElementById('artistName');
                    const artistText = artistName ? artistName.textContent : 'æ­Œæ‰‹';
                    ctx.fillStyle = '#a0a8b0'; // ä¸­ç­‰äº®åº¦çš„æ–‡å­—
                    ctx.font = '24px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                    ctx.fillText(artistText, canvas.width / 2, songSectionY + 85);

                    // ç»˜åˆ¶è¯„è®ºåŒºåŸŸ
                    const commentY = songSectionY + songSectionHeight + 60;

                    // ç”¨æˆ·å¤´åƒ
                    const avatarSize = 80;
                    const avatarX = containerX + 60;
                    const avatarYPos = commentY;

                    const avatarGradient = ctx.createLinearGradient(avatarX, avatarYPos, avatarX + avatarSize, avatarYPos + avatarSize);
                    avatarGradient.addColorStop(0, '#667eea');
                    avatarGradient.addColorStop(1, '#764ba2');
                    ctx.fillStyle = avatarGradient;
                    ctx.beginPath();
                    ctx.arc(avatarX + avatarSize/2, avatarYPos + avatarSize/2, avatarSize/2, 0, 2 * Math.PI);
                    ctx.fill();

                    // å¤´åƒæ–‡å­—
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 36px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const usernameDisplay = document.getElementById('usernameDisplay');
                    const avatarText = usernameDisplay ? usernameDisplay.textContent.charAt(0) : 'æ·±';
                    ctx.fillText(avatarText, avatarX + avatarSize/2, avatarYPos + avatarSize/2);

                    // ç”¨æˆ·åå’Œæ—¥æœŸï¼ˆå¤œé—´æ¨¡å¼ï¼‰
                    ctx.fillStyle = '#d0d6dd'; // æµ…è‰²ç”¨æˆ·å
                    ctx.font = 'bold 28px Arial';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    const username = usernameDisplay ? usernameDisplay.textContent : 'æ·±æµ·é‡Œçš„é±¼';
                    ctx.fillText(username, avatarX + avatarSize + 30, avatarYPos + 10);

                    ctx.fillStyle = '#8a9199'; // ä¸­ç­‰äº®åº¦çš„æ—¥æœŸ
                    ctx.font = '20px Arial';
                    const dateDisplay = document.getElementById('dateDisplay');
                    const dateText = dateDisplay ? dateDisplay.textContent : '2024å¹´03æœˆ15æ—¥';
                    ctx.fillText(dateText, avatarX + avatarSize + 30, avatarYPos + 50);

                    // è¯„è®ºå†…å®¹ï¼ˆå¤œé—´æ¨¡å¼ï¼‰
                    const contentDisplay = document.getElementById('contentDisplay');
                    const contentText = contentDisplay ? contentDisplay.textContent : 'å‡Œæ™¨ä¸‰ç‚¹çš„é›¨å£°ï¼Œåƒæäº†æˆ‘å†…å¿ƒçš„ç‹¬ç™½';

                    ctx.fillStyle = '#e8eef5'; // æ˜äº®çš„è¯„è®ºæ–‡å­—
                    ctx.font = 'bold 36px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // æ–‡å­—æ¢è¡Œå¤„ç†
                    const maxWidth = containerWidth - 120;
                    const lineHeight = 55;
                    const words = contentText.split('');
                    let line = '';
                    let y = commentY + 150;

                    for (let i = 0; i < words.length; i++) {
                        const testLine = line + words[i];
                        const metrics = ctx.measureText(testLine);
                        const testWidth = metrics.width;

                        if (testWidth > maxWidth && i > 0) {
                            ctx.fillText(line, canvas.width / 2, y);
                            line = words[i];
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, canvas.width / 2, y);

                    resolve(canvas);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // è®¾ç½®æµ·æŠ¥å°ºå¯¸
        function setPosterSize(size) {
            const posterContainer = document.getElementById('posterContainer');
            const commentCard = document.getElementById('commentCard');
            const verticalBtn = document.getElementById('verticalBtn');
            const squareBtn = document.getElementById('squareBtn');

            if (size === 'vertical') {
                // ç«–å± 9:16
                posterContainer.style.width = '300px';
                posterContainer.style.height = '533px';

                // è°ƒæ•´å†…å®¹å¸ƒå±€ä¸ºç«–å±æ¨¡å¼
                commentCard.style.padding = '40px 30px';
                commentCard.style.justifyContent = 'space-between';

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                verticalBtn.style.background = '#667eea';
                verticalBtn.style.color = 'white';
                squareBtn.style.background = 'transparent';
                squareBtn.style.color = '#667eea';
            } else if (size === 'square') {
                // æ–¹å½¢ 1:1
                posterContainer.style.width = '400px';
                posterContainer.style.height = '400px';

                // è°ƒæ•´å†…å®¹å¸ƒå±€ä¸ºæ–¹å½¢æ¨¡å¼
                commentCard.style.padding = '30px 25px';
                commentCard.style.justifyContent = 'space-around';

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                squareBtn.style.background = '#667eea';
                squareBtn.style.color = 'white';
                verticalBtn.style.background = 'transparent';
                verticalBtn.style.color = '#667eea';
            }

            // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
            posterContainer.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

            // è°ƒæ•´å†…å®¹åŒºåŸŸçš„å¸ƒå±€
            adjustContentLayout(size);

            // é‡æ–°è°ƒæ•´æ­Œæ›²ä¿¡æ¯å­—ä½“å¤§å°
            setTimeout(() => {
                const songName = document.getElementById('cardSongName');
                const songArtist = document.getElementById('cardSongArtist');
                if (songName && songName.textContent.trim()) {
                    autoResizeText(songName, 13);
                }
                if (songArtist && songArtist.textContent.trim()) {
                    autoResizeText(songArtist, 10);
                }
            }, 100);
        }

        // è°ƒæ•´å†…å®¹å¸ƒå±€
        function adjustContentLayout(size) {
            const userInfoSection = document.querySelector('.comment-card > div:first-child');
            const contentSection = document.querySelector('.comment-card > div:nth-child(2)');
            const songSection = document.getElementById('songSection');
            const cardSongName = document.getElementById('cardSongName');
            const cardSongArtist = document.getElementById('cardSongArtist');
            const contentDisplay = document.getElementById('contentDisplay');

            if (size === 'square') {
                // æ–¹å½¢æ¨¡å¼ï¼šç´§å‡‘å¸ƒå±€
                if (userInfoSection) {
                    userInfoSection.style.marginBottom = '15px';
                }
                if (contentSection) {
                    contentSection.style.padding = '10px 0';
                }
                if (contentDisplay) {
                    contentDisplay.style.fontSize = '15px';
                    contentDisplay.style.lineHeight = '1.5';
                    contentDisplay.style.marginBottom = '10px';
                    contentDisplay.style.padding = '0 8px';
                }
                if (songSection) {
                    songSection.style.padding = '10px';
                    songSection.style.minHeight = '45px';
                    songSection.style.marginTop = '15px';
                    songSection.style.borderRadius = '14px';
                }
                // è°ƒæ•´æ­Œæ›²ä¿¡æ¯å­—ä½“å’Œé—´è·
                if (cardSongName) {
                    cardSongName.style.height = '28px';
                    cardSongName.style.marginBottom = '2px';
                }
                if (cardSongArtist) {
                    cardSongArtist.style.height = '20px';
                }

                // è°ƒæ•´å¼•å·å¤§å°
                const quotes = document.querySelectorAll('.comment-card div[style*="font-size: 40px"]');
                quotes.forEach(quote => {
                    quote.style.fontSize = '32px';
                    quote.style.marginBottom = '10px';
                });

            } else {
                // ç«–å±æ¨¡å¼ï¼šæ ‡å‡†å¸ƒå±€
                if (userInfoSection) {
                    userInfoSection.style.marginBottom = '30px';
                }
                if (contentSection) {
                    contentSection.style.padding = '20px 0';
                }
                if (contentDisplay) {
                    contentDisplay.style.fontSize = '18px';
                    contentDisplay.style.lineHeight = '1.8';
                    contentDisplay.style.marginBottom = '15px';
                    contentDisplay.style.padding = '0 10px';
                }
                if (songSection) {
                    songSection.style.padding = '16px';
                    songSection.style.minHeight = '65px';
                    songSection.style.marginTop = '20px';
                    songSection.style.borderRadius = '18px';
                }
                // æ¢å¤æ­Œæ›²ä¿¡æ¯æ ‡å‡†å°ºå¯¸
                if (cardSongName) {
                    cardSongName.style.height = '32px';
                    cardSongName.style.marginBottom = '4px';
                }
                if (cardSongArtist) {
                    cardSongArtist.style.height = '24px';
                }

                // æ¢å¤å¼•å·å¤§å°
                const quotes = document.querySelectorAll('.comment-card div[style*="font-size: 32px"], .comment-card div[style*="font-size: 40px"]');
                quotes.forEach(quote => {
                    quote.style.fontSize = '40px';
                    quote.style.marginBottom = '15px';
                });
            }
        }

        // å¤´åƒä¸Šä¼ 
        document.getElementById('avatar').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarDisplay = document.getElementById('avatarDisplay');
                    avatarDisplay.innerHTML = `<img src="${e.target.result}" alt="å¤´åƒ">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // å¯¼å‡ºå›¾ç‰‡
        function exportImage() {
            // æ£€æµ‹è®¾å¤‡ç±»å‹
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                alert('ğŸ“± ç§»åŠ¨ç«¯ä¿å­˜æ–¹æ³•ï¼š\n1. é•¿æŒ‰è¯„è®ºå¡ç‰‡åŒºåŸŸ\n2. é€‰æ‹©"ä¿å­˜å›¾ç‰‡"æˆ–"æ·»åŠ åˆ°ç…§ç‰‡"\n3. å›¾ç‰‡å°†ä¿å­˜åˆ°ç›¸å†Œ');
            } else {
                alert('ğŸ’» ç”µè„‘ç«¯ä¿å­˜æ–¹æ³•ï¼š\n1. å³é”®ç‚¹å‡»è¯„è®ºå¡ç‰‡\n2. é€‰æ‹©"å°†å›¾åƒå¦å­˜ä¸º"\n3. æˆ–ä½¿ç”¨æˆªå›¾å·¥å…·æˆªå–å¡ç‰‡åŒºåŸŸ');
            }
        }

        // ç”Ÿæˆå¾ªç¯æ’­æ”¾è§†é¢‘
        async function generateVideo() {
            const posterContainer = document.getElementById('posterContainer');
            if (!posterContainer) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€æ¡è¯„è®ºç”Ÿæˆæµ·æŠ¥');
                return;
            }

            // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                z-index: 10000;
                text-align: center;
            `;
            progressDiv.innerHTML = 'ğŸ¬ æ­£åœ¨ç”Ÿæˆè§†é¢‘...<br><div id="progress">å‡†å¤‡ä¸­...</div>';
            document.body.appendChild(progressDiv);

            try {
                // åˆ›å»ºcanvasç”¨äºå½•åˆ¶
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è·å–æµ·æŠ¥å®¹å™¨çš„å°ºå¯¸
                const rect = posterContainer.getBoundingClientRect();
                canvas.width = rect.width * 2; // æé«˜åˆ†è¾¨ç‡
                canvas.height = rect.height * 2;

                // ä¸´æ—¶è°ƒæ•´æ ·å¼ä»¥ç¡®ä¿html2canvasæ­£ç¡®æ¸²æŸ“
                const elementsToFix = [];

                // å¤„ç†backdrop-filter - ç”¨å®ä½“èƒŒæ™¯æ›¿ä»£
                const elementsWithBackdrop = posterContainer.querySelectorAll('[style*="backdrop-filter"]');
                elementsWithBackdrop.forEach(el => {
                    const originalBackdrop = el.style.backdropFilter;
                    const originalBackground = el.style.background;
                    elementsToFix.push({
                        el,
                        props: {
                            backdropFilter: originalBackdrop,
                            background: originalBackground
                        }
                    });

                    el.style.backdropFilter = 'none';
                    // æ ¹æ®å…ƒç´ ç±»å‹è®¾ç½®åˆé€‚çš„èƒŒæ™¯
                    if (el.id === 'glassOverlay') {
                        el.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(248, 250, 252, 0.15) 50%, rgba(255, 255, 255, 0.3) 100%)';
                    } else if (el.id === 'songSection') {
                        el.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%)';
                    } else {
                        el.style.background = 'rgba(255,255,255,0.2)';
                    }
                });

                // å¤„ç†mix-blend-mode
                const elementsWithBlend = posterContainer.querySelectorAll('[style*="mix-blend-mode"]');
                elementsWithBlend.forEach(el => {
                    const originalBlend = el.style.mixBlendMode;
                    elementsToFix.push({
                        el,
                        props: { mixBlendMode: originalBlend }
                    });
                    el.style.mixBlendMode = 'normal';
                });

                // ç¡®ä¿å®¹å™¨æœ‰æ˜ç¡®çš„èƒŒæ™¯
                const originalContainerBg = posterContainer.style.background;
                elementsToFix.push({
                    el: posterContainer,
                    props: { background: originalContainerBg }
                });
                if (!posterContainer.style.background || posterContainer.style.background === 'transparent') {
                    posterContainer.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%)';
                }

                // åˆ›å»ºMediaRecorderï¼Œä¼˜å…ˆä½¿ç”¨é«˜è´¨é‡ç¼–ç 
                const stream = canvas.captureStream(30); // 30fps
                let mimeType = 'video/webm;codecs=vp9';

                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„æ ¼å¼
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
                        mimeType = 'video/webm;codecs=vp8';
                    } else if (MediaRecorder.isTypeSupported('video/webm')) {
                        mimeType = 'video/webm';
                    } else if (MediaRecorder.isTypeSupported('video/mp4')) {
                        mimeType = 'video/mp4';
                    }
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 2500000 // 2.5Mbps é«˜è´¨é‡
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);

                    // è·å–å½“å‰æ—¶é—´ä½œä¸ºæ–‡ä»¶å
                    const now = new Date();
                    const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '');
                    const extension = mimeType.includes('mp4') ? 'mp4' : 'webm';

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `éŸ³ä¹æµ·æŠ¥è§†é¢‘_${timestamp}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    document.body.removeChild(progressDiv);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 15px;
                        z-index: 10000;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
                        animation: fadeInScale 0.5s ease;
                    `;
                    successDiv.innerHTML = `
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ‰</div>
                        <div style="font-size: 16px; font-weight: 600;">è§†é¢‘ç”Ÿæˆå®Œæˆï¼</div>
                        <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">å·²å¼€å§‹ä¸‹è½½ ${extension.toUpperCase()} æ ¼å¼è§†é¢‘</div>
                    `;
                    document.body.appendChild(successDiv);

                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);
                };

                // å¼€å§‹å½•åˆ¶
                mediaRecorder.start();

                // å½•åˆ¶åŠ¨ç”»å¸§
                let frame = 0;
                const totalFrames = 150; // 5ç§’ * 30fps
                let posterCanvas = null;

                // ç­‰å¾…ä¸€ä¸‹è®©æ ·å¼ç”Ÿæ•ˆ
                setTimeout(() => {
                    document.getElementById('progress').textContent = 'æ­£åœ¨æ•è·æµ·æŠ¥...';

                    // ç”Ÿæˆæµ·æŠ¥canvas - ä½¿ç”¨ç®€åŒ–é…ç½®
                    html2canvas(posterContainer, {
                        scale: 1, // é™ä½scaleé¿å…å†…å­˜é—®é¢˜
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#f0f0f0', // è®¾ç½®é»˜è®¤èƒŒæ™¯è‰²
                        logging: true,
                        width: posterContainer.offsetWidth,
                        height: posterContainer.offsetHeight,
                        onclone: (clonedDoc) => {
                            console.log('å¼€å§‹å…‹éš†æ–‡æ¡£...');
                            const clonedContainer = clonedDoc.getElementById('posterContainer');
                            if (clonedContainer) {
                                console.log('æ‰¾åˆ°å…‹éš†çš„å®¹å™¨');

                                // ç¡®ä¿å®¹å™¨å¯è§
                                clonedContainer.style.display = 'block';
                                clonedContainer.style.visibility = 'visible';
                                clonedContainer.style.opacity = '1';

                                // è®¾ç½®æ˜ç¡®çš„å°ºå¯¸
                                clonedContainer.style.width = posterContainer.offsetWidth + 'px';
                                clonedContainer.style.height = posterContainer.offsetHeight + 'px';

                                // è®¾ç½®å¤œé—´æ¨¡å¼èƒŒæ™¯
                                if (!clonedContainer.style.background || clonedContainer.style.background === 'transparent') {
                                    clonedContainer.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 75%, #1a1a2e 100%)';
                                }

                                // ç¡®ä¿æ‰€æœ‰å­å…ƒç´ å¯è§
                                const allElements = clonedContainer.querySelectorAll('*');
                                allElements.forEach(el => {
                                    el.style.visibility = 'visible';
                                    if (el.style.opacity === '0') {
                                        el.style.opacity = '1';
                                    }
                                    if (el.style.display === 'none') {
                                        el.style.display = 'block';
                                    }
                                });

                                console.log('å…‹éš†æ–‡æ¡£å¤„ç†å®Œæˆ');
                            } else {
                                console.error('æœªæ‰¾åˆ°å…‹éš†çš„å®¹å™¨');
                            }
                        }
                    }).then(canvas => {
                        // æ¢å¤åŸå§‹æ ·å¼
                        elementsToFix.forEach(({el, props}) => {
                            Object.keys(props).forEach(prop => {
                                el.style[prop] = props[prop];
                            });
                        });

                        posterCanvas = canvas;
                        console.log('æµ·æŠ¥canvasç”ŸæˆæˆåŠŸï¼Œå°ºå¯¸:', canvas.width, 'x', canvas.height);

                        // æ£€æŸ¥canvasæ˜¯å¦æœ‰å†…å®¹
                        const tempCtx = canvas.getContext('2d');
                        const imageData = tempCtx.getImageData(0, 0, canvas.width, canvas.height);
                        const hasContent = imageData.data.some(pixel => pixel !== 0);
                        console.log('æµ·æŠ¥canvasæ˜¯å¦æœ‰å†…å®¹:', hasContent);

                        if (!hasContent) {
                            console.warn('æµ·æŠ¥canvasä¸ºç©ºï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
                            throw new Error('æµ·æŠ¥canvasä¸ºç©º');
                        }

                        document.getElementById('progress').textContent = 'å¼€å§‹å½•åˆ¶è§†é¢‘...';
                        recordFrame(); // å¼€å§‹å½•åˆ¶
                    }).catch(error => {
                        // æ¢å¤åŸå§‹æ ·å¼
                        elementsToFix.forEach(({el, props}) => {
                            Object.keys(props).forEach(prop => {
                                el.style[prop] = props[prop];
                            });
                        });

                        console.error('html2canvaså¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ç»˜åˆ¶:', error);
                        document.getElementById('progress').textContent = 'ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ...';

                        // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨ç»˜åˆ¶æµ·æŠ¥
                        createManualPoster().then(manualCanvas => {
                            posterCanvas = manualCanvas;
                            console.log('æ‰‹åŠ¨æµ·æŠ¥ç”ŸæˆæˆåŠŸ');
                            document.getElementById('progress').textContent = 'å¼€å§‹å½•åˆ¶è§†é¢‘...';
                            recordFrame();
                        }).catch(manualError => {
                            console.error('æ‰‹åŠ¨ç»˜åˆ¶ä¹Ÿå¤±è´¥:', manualError);
                            document.body.removeChild(progressDiv);
                            alert('âŒ è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                        });
                    });
                }, 100);

                function recordFrame() {
                    if (!posterCanvas) {
                        console.error('posterCanvasä¸ºç©ºï¼Œæ— æ³•å½•åˆ¶');
                        return;
                    }

                    // è°ƒè¯•ä¿¡æ¯
                    if (frame === 0) {
                        console.log('å¼€å§‹å½•åˆ¶ï¼Œæµ·æŠ¥å°ºå¯¸:', posterCanvas.width, 'x', posterCanvas.height);
                        console.log('è§†é¢‘canvaså°ºå¯¸:', canvas.width, 'x', canvas.height);
                    }

                    // æ¸…é™¤canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // åˆ›å»ºåŠ¨ç”»æ•ˆæœ
                    const progress = frame / totalFrames;
                    const time = progress * 2 * Math.PI; // 1ä¸ªå®Œæ•´å¾ªç¯

                    // åˆ›å»ºå¤œé—´æ¨¡å¼åŠ¨æ€èƒŒæ™¯
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    const hue1 = (time * 15 + 220) % 360; // æ·±è“ç´«è‰²ç³»
                    const hue2 = (time * 15 + 260) % 360; // æ·±ç´«è‰²ç³»
                    gradient.addColorStop(0, `hsla(${hue1}, 40%, 8%, 1)`);   // å¾ˆæ·±çš„èƒŒæ™¯
                    gradient.addColorStop(0.5, `hsla(${(hue1 + hue2) / 2}, 35%, 6%, 1)`);
                    gradient.addColorStop(1, `hsla(${hue2}, 40%, 8%, 1)`);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // æ·»åŠ å¤œé—´æ¨¡å¼å…‰æ•ˆï¼ˆæ›´æŸ”å’Œï¼‰
                    for (let i = 0; i < 4; i++) {
                        const lightTime = time + i * 1.2;
                        const x = (Math.sin(lightTime * 0.4) * 0.25 + 0.5) * canvas.width;
                        const y = (Math.cos(lightTime * 0.25) * 0.25 + 0.5) * canvas.height;
                        const size = Math.sin(lightTime * 1.0) * 30 + 50;
                        const opacity = Math.sin(lightTime * 1.2) * 0.08 + 0.12; // æ›´ä½çš„é€æ˜åº¦

                        const lightGradient = ctx.createRadialGradient(x, y, 0, x, y, size);
                        lightGradient.addColorStop(0, `hsla(${(lightTime * 30 + 200) % 360}, 60%, 50%, ${opacity})`); // æ›´æš—çš„å…‰æ•ˆ
                        lightGradient.addColorStop(1, 'transparent');
                        ctx.fillStyle = lightGradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }

                    // è®¡ç®—æµ·æŠ¥åœ¨è§†é¢‘ä¸­çš„åˆé€‚å°ºå¯¸
                    const posterAspect = posterCanvas.width / posterCanvas.height;
                    const canvasAspect = canvas.width / canvas.height;

                    let baseWidth, baseHeight;

                    // æ ¹æ®å®½é«˜æ¯”å†³å®šç¼©æ”¾æ–¹å¼
                    if (posterAspect > canvasAspect) {
                        // æµ·æŠ¥æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
                        baseWidth = canvas.width * 0.7; // å è§†é¢‘å®½åº¦çš„70%
                        baseHeight = baseWidth / posterAspect;
                    } else {
                        // æµ·æŠ¥æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                        baseHeight = canvas.height * 0.7; // å è§†é¢‘é«˜åº¦çš„70%
                        baseWidth = baseHeight * posterAspect;
                    }

                    // æ·»åŠ è½»å¾®çš„å‘¼å¸åŠ¨ç”»
                    const scale = 1 + Math.sin(time * 0.8) * 0.02;
                    const drawWidth = baseWidth * scale;
                    const drawHeight = baseHeight * scale;
                    const x = (canvas.width - drawWidth) / 2;
                    const y = (canvas.height - drawHeight) / 2;

                    // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…ç¬¬ä¸€å¸§ï¼‰
                    if (frame === 0) {
                        console.log('ç»˜åˆ¶ä½ç½®:', x, y, 'å°ºå¯¸:', drawWidth, drawHeight);
                    }

                    // ç»˜åˆ¶æµ·æŠ¥ï¼ˆæ— é˜´å½±ï¼‰
                    try {
                        ctx.drawImage(posterCanvas, x, y, drawWidth, drawHeight);
                    } catch (error) {
                        console.error('ç»˜åˆ¶æµ·æŠ¥å¤±è´¥:', error);
                    }

                    // æ·»åŠ ç®€æ´çš„è¾¹æ¡†ï¼ˆæ— é˜´å½±ï¼‰
                    ctx.save();
                    ctx.strokeStyle = `hsla(${(time * 30 + 180) % 360}, 50%, 60%, 0.6)`; // æ›´æŸ”å’Œçš„è¾¹æ¡†è‰²
                    ctx.lineWidth = 1.5; // æ›´ç»†çš„è¾¹æ¡†
                    ctx.setLineDash([3, 3]); // æ›´å°çš„è™šçº¿
                    ctx.lineDashOffset = time * 8;
                    ctx.strokeRect(x - 0.75, y - 0.75, drawWidth + 1.5, drawHeight + 1.5);
                    ctx.restore();

                    // æ›´æ–°è¿›åº¦
                    const progressPercent = Math.round((frame / totalFrames) * 100);
                    document.getElementById('progress').textContent = `å½•åˆ¶ä¸­ ${progressPercent}%`;

                    frame++;
                    if (frame < totalFrames) {
                        setTimeout(recordFrame, 1000 / 30); // 30fps
                    } else {
                        mediaRecorder.stop();
                    }
                }

                // å¼€å§‹å½•åˆ¶ç¬¬ä¸€å¸§
                recordFrame();

            } catch (error) {
                console.error('è§†é¢‘ç”Ÿæˆå¤±è´¥:', error);
                document.body.removeChild(progressDiv);
                alert('âŒ è§†é¢‘ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè§†é¢‘å½•åˆ¶åŠŸèƒ½');
            }
        }

        // ç»‘å®šè¾“å…¥äº‹ä»¶ - å½“ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥æ—¶æ¸…é™¤é€‰ä¸­çš„è¯„è®º
        document.getElementById('username').addEventListener('input', function() {
            selectedComment = null; // æ¸…é™¤é€‰ä¸­è¯„è®ºï¼Œä½¿ç”¨è¡¨å•æ•°æ®
            updatePreview();
        });
        document.getElementById('isVip').addEventListener('change', function() {
            selectedComment = null;
            updatePreview();
        });
        document.getElementById('date').addEventListener('input', function() {
            selectedComment = null;
            updatePreview();
        });
        document.getElementById('hotTag').addEventListener('change', function() {
            selectedComment = null;
            updatePreview();
        });
        document.getElementById('content').addEventListener('input', function() {
            selectedComment = null; // ç”¨æˆ·è¾“å…¥è¯„è®ºå†…å®¹æ—¶æ¸…é™¤é€‰ä¸­è¯„è®º
            updatePreview();
        });
        document.getElementById('likes').addEventListener('input', function() {
            selectedComment = null;
            updatePreview();
        });

        // ç»‘å®šæ­Œæ›²æœç´¢å›è½¦äº‹ä»¶
        document.getElementById('songSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchSong();
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœï¼ˆä½†ä¸éšè—è¯„è®ºç•Œé¢ï¼‰
        document.addEventListener('click', function(e) {
            const songSearch = document.getElementById('songSearch');
            const songResults = document.getElementById('songResults');

            // æ£€æŸ¥æ˜¯å¦åœ¨æ˜¾ç¤ºè¯„è®ºç•Œé¢ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦æœ‰è¯„è®ºæŒ‰é’®ï¼‰
            const hasCommentButtons = songResults && songResults.innerHTML.includes('loadHotCommentsForSelectedSong');

            // å¦‚æœæ­£åœ¨æ˜¾ç¤ºè¯„è®ºç•Œé¢ï¼Œä¸è¦éšè—
            if (hasCommentButtons) {
                return;
            }

            if (!songSearch.contains(e.target) && !songResults.contains(e.target)) {
                songResults.style.display = 'none';
            }
        });

        // æ·»åŠ å…¨å±€é”™è¯¯ç›‘å¬å™¨
        window.addEventListener('error', function(e) {
            if (e.target !== window) {
                console.warn('èµ„æºåŠ è½½å¤±è´¥:', e.target.src || e.target.href, e);
            }
        });

        // ç›‘å¬ç½‘ç»œè¯·æ±‚é”™è¯¯
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
            setToday();

            // åˆå§‹åŒ–é¢„è§ˆå†…å®¹
            updatePreview();
        });
    </script>
</body>
</html>
